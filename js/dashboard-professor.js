(function(){
const API=window.__API_URL__||window.API_URL||"http://localhost:5001/api";
const data={professorName:"",courses:[],availableCourses:[],materials:[],schedule:[],messages:[],students:[],chatGroups:[],notifications:[],inboxMessages:[]};
const dismissedSchedule=new Set(JSON.parse(localStorage.getItem("professor_dismissed_schedule")||"[]"));
const id=(x)=>document.getElementById(x);
const token=()=>localStorage.getItem("token")||sessionStorage.getItem("token")||"";
const esc=(v)=>String(v||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m]));
const readMsg=new Set(JSON.parse(localStorage.getItem("prof_read_messages")||"[]"));
const readNotif=new Set(JSON.parse(localStorage.getItem("prof_read_notifications")||"[]"));
const dismissedInbox=new Set(JSON.parse(localStorage.getItem("prof_dismiss_inbox")||"[]"));
const dismissedSent=new Set(JSON.parse(localStorage.getItem("prof_dismiss_sent")||"[]"));
let realtimeReady=false;let polling=false;
let knownNotifIds=new Set();
let knownInboxMsgIds=new Set();
function saveRead(){localStorage.setItem("prof_read_messages",JSON.stringify(Array.from(readMsg)));localStorage.setItem("prof_read_notifications",JSON.stringify(Array.from(readNotif)));}
function saveDismissed(){localStorage.setItem("prof_dismiss_inbox",JSON.stringify([...dismissedInbox]));localStorage.setItem("prof_dismiss_sent",JSON.stringify([...dismissedSent]));}
function clearAuthAndRedirect(msg){try{localStorage.removeItem("token");sessionStorage.removeItem("token");localStorage.removeItem("user");sessionStorage.removeItem("user");localStorage.removeItem("admin_token");}catch{}if(msg)showAlert(msg,"error");setTimeout(()=>{if(!/login\\.html/i.test(location.pathname))location.href="login.html?reason=expired";},600);}
async function api(path,opt={}){const h={"Content-Type":"application/json",...(opt.headers||{})};const t=token();if(t)h.Authorization=`Bearer ${t}`;const ctl=new AbortController();const timeoutMs=15000;const timeout=setTimeout(()=>ctl.abort(),timeoutMs);let r;try{r=await fetch(`${API}${path}`,{...opt,headers:h,signal:ctl.signal});}catch(err){if(err?.name==="AbortError")throw new Error("A requisicao demorou demasiado. Verifique a ligacao.");throw err;}finally{clearTimeout(timeout);}const j=await r.json().catch(()=>({}));if(r.status===401){clearAuthAndRedirect(j.error||"Token invalido ou expirado");throw new Error(j.error||"Token invalido ou expirado");}if(!r.ok)throw new Error(j.error||`HTTP ${r.status}`);return j;}
function showAlert(msg,type="success"){const a=document.createElement("div");a.className="alert";a.style.borderLeftColor=type==="success"?"#10b981":"#ef4444";a.innerHTML=`<div style="font-weight:500;margin-bottom:4px;">${esc(msg)}</div><div style="font-size:0.85rem;color:var(--gray);">${new Date().toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"})}</div>`;document.body.appendChild(a);setTimeout(()=>a.remove(),3000);} 
function openModal(mid){const m=id(mid);if(m)m.style.display="flex";} function closeModal(mid){const m=id(mid);if(m)m.style.display="none";}
function info(title,body){id("infoModalTitle").textContent=title;id("infoModalBody").innerHTML=body;openModal("infoModal");}
function confirmAction(title,body,run){id("confirmModalTitle").textContent=title;id("confirmModalBody").innerHTML=body;const btn=id("confirmModalConfirm");btn.onclick=async()=>{await run();closeModal("confirmModal");};openModal("confirmModal");}
function saveDismissedSchedule(){localStorage.setItem("professor_dismissed_schedule",JSON.stringify([...dismissedSchedule]));}
function setProfile(name){const p=document.querySelector(".profile-text h3");const r=document.querySelector(".profile-text p");const a=document.querySelector(".avatar");if(p)p.textContent=name||"Professor";if(r)r.textContent="Professor";if(a)a.textContent=(name||"PR").split(" ").filter(Boolean).slice(0,2).map(s=>s[0]).join("").toUpperCase();id("pageSubtitle").textContent=`Bem-vindo(a), Professor(a) ${name}!`;}
function mapData(me,d,inbox){data.professorName=me.user?.name||"Professor";data.courses=(d.courses||[]).map(c=>({id:c.id,name:c.title,students:Number(c.students||0),nextClass:"-"}));data.materials=(d.materials||[]).map(m=>({id:m.id,name:m.title,type:m.type,course:m.course_title||"Geral",date:(m.created_at||"").slice(0,10),status:m.approval_status||"pending",visibility:m.visibility||"public",file:m.file_name||"-"}));data.schedule=(d.schedule||[]).map(s=>{let contentList=[];let materialsList=[];try{const parsed=JSON.parse(s.content||"[]");if(Array.isArray(parsed))contentList=parsed;}catch{contentList=[];}try{const parsed=JSON.parse(s.support_materials||"[]");if(Array.isArray(parsed))materialsList=parsed;}catch{materialsList=[];}if(!contentList.length&&typeof s.content==="string"&&s.content.trim())contentList=[s.content.trim()];if(!materialsList.length&&typeof s.support_materials==="string"&&s.support_materials.trim())materialsList=[s.support_materials.trim()];return{ id:s.id, title:s.title, description:s.description||"", course:s.course_title||s.title, rawDate:s.scheduled_at||null, time:s.scheduled_at?new Date(s.scheduled_at).toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"}):"-", type:s.status==="live"?"Ao Vivo":"Agendada", status:s.status||"scheduled", meetingLink:s.meeting_link||"", visibility:s.visibility||"public", approval:s.approval_status||"pending", duration:Number(s.duration_minutes||60), capacity:Number(s.capacity||25), level:s.level||"intermediario", content:contentList, materials:materialsList };});data.messages=(d.messages||[]).map(m=>({id:m.id,to:m.target_type==="all"?"Todos alunos":m.target_type==="course"?"Por curso":"Aluno específico",subject:m.subject,content:m.content||"",date:new Date(m.created_at).toLocaleString("pt-BR",{day:"2-digit",month:"2-digit",hour:"2-digit",minute:"2-digit"})}));data.students=(d.students||[]).map(s=>({id:s.enrollment_id,name:s.name,email:s.email,courseId:s.course_id,courseTitle:s.course_title||"-",progress:Number(s.progress||10),level:s.level||"iniciante"}));data.chatGroups=(d.chatGroups||[]).map(g=>({id:g.id,name:g.name,course:g.course_title||"Livre",status:g.status||"pending",createdAt:g.created_at}));data.notifications=(inbox.notifications||[]);data.inboxMessages=(inbox.messages||[]);}
async function loadData(){const t=token();if(!t){location.href="login.html";throw new Error("Não autenticado");}const me=await api("/auth/me");if(me.user?.role!=="professor"){location.href="login.html";throw new Error("Acesso apenas para professor");}const [dash,inbox,allCourses]=await Promise.all([api("/professor/dashboard"),api("/notifications/my").catch(()=>({notifications:[],messages:[]})),api("/courses").catch(()=>({courses:[]}))]);mapData(me,dash,inbox);data.availableCourses=(allCourses.courses||[]).filter(c=>Number(c.active||1)===1).map(c=>({id:c.id,name:c.title||c.id}));setProfile(data.professorName);refreshNotificationBadges();} 
function refreshNotificationBadges(){const unreadNotif=data.notifications.filter(n=>!readNotif.has(String(n.id))).length;const unreadMsg=data.inboxMessages.filter(m=>!readMsg.has(String(m.id))).length;const total=unreadNotif+unreadMsg;const sb=id("sidebarMessageBadge");const hb=id("headerNotificationBadge");if(sb){sb.textContent=String(total);sb.style.display=total>0?"inline-flex":"none";}if(hb){hb.textContent=String(total);hb.style.display=total>0?"inline-flex":"none";}}
function maybePopupRealtime(){const notifIds=new Set((data.notifications||[]).map(n=>String(n.id)));const msgIds=new Set((data.inboxMessages||[]).map(m=>String(m.id)));const unreadNotifs=(data.notifications||[]).filter(n=>!readNotif.has(String(n.id)));const unreadMsgs=(data.inboxMessages||[]).filter(m=>!readMsg.has(String(m.id)));if(!realtimeReady){knownNotifIds=notifIds;knownInboxMsgIds=msgIds;realtimeReady=true;if(unreadNotifs.length>0)showAlert(`${unreadNotifs.length} notificacao(oes) pendente(s)`);if(unreadMsgs.length>0)showAlert(`${unreadMsgs.length} mensagem(s) nao lida(s)`);return;}const newNotifs=(data.notifications||[]).filter(n=>!knownNotifIds.has(String(n.id)));const newMsgs=(data.inboxMessages||[]).filter(m=>!knownInboxMsgIds.has(String(m.id)));if(newNotifs.length>0)showAlert(`${newNotifs.length} nova(s) notificacao(oes) recebida(s)`);if(newMsgs.length>0)showAlert(`${newMsgs.length} nova(s) mensagem(s) recebida(s)`);knownNotifIds=notifIds;knownInboxMsgIds=msgIds;}
function refreshStats(){const tot=data.courses.reduce((a,c)=>a+Number(c.students||0),0);const key=new Date().toDateString();const today=data.schedule.filter(s=>{const d=s.rawDate?new Date(s.rawDate):null;return d&&d.toDateString()===key;}).length;id("statStudents").textContent=tot;id("statCourses").textContent=data.courses.length;id("statTodayClasses").textContent=today;id("statRating").textContent="--";}
function populateCourseOptions(){const opts=['<option value="">Selecione um curso</option>'].concat(data.courses.map(c=>`<option value="${c.id}">${esc(c.name)}</option>`)).join("");if(id("materialCourse"))id("materialCourse").innerHTML=opts;if(id("scheduleCourse"))id("scheduleCourse").innerHTML=opts;const mTarget=id("messageTargetValue");if(mTarget)mTarget.innerHTML='<option value="">Selecione</option>';const chatCourse=id("chatGroupCourse");if(chatCourse)chatCourse.innerHTML='<option value="">Sem curso especifico</option>'+data.courses.map(c=>`<option value="${c.id}">${esc(c.name)}</option>`).join("");const reqCourse=id("requestCourse");if(reqCourse){const reqOpts=['<option value="">Selecione um curso</option>'].concat(data.availableCourses.map(c=>`<option value="${c.id}">${esc(c.name)}</option>`)).join("");reqCourse.innerHTML=reqOpts;}}
function refreshMessageTargetOptions(){const type=id("messageTo")?.value||"all";const wrap=id("messageTargetWrap");const target=id("messageTargetValue");if(!wrap||!target)return;if(type==="all"){wrap.style.display="none";target.innerHTML="";return;}wrap.style.display="block";if(type==="course"){target.innerHTML='<option value="">Selecione o curso</option>'+data.courses.map(c=>`<option value="${c.id}">${esc(c.name)}</option>`).join("");return;}const uniq=new Map();data.students.forEach(s=>{if(!uniq.has(s.email))uniq.set(s.email,s);});target.innerHTML='<option value="">Selecione o aluno</option>'+Array.from(uniq.values()).map(s=>`<option value="${esc(s.email)}">${esc(s.name)} (${esc(s.email)})</option>`).join("");}
function updateMaterialsGrid(el,mats){const g=id(el);if(!g)return;g.innerHTML=mats.map(m=>`<div class="material-item"><div class="material-icon"><i class="fas fa-${matIcon(m.type)}"></i></div><div class="material-name">${esc(m.name)}</div><div class="material-meta"><div>${esc(m.course)}</div><div>${esc(m.date)}</div><div>${esc(m.visibility==="enrolled"?"Inscritos":"Público")}</div><div>${esc(m.status)}</div></div><div style="display:flex;gap:8px;margin-top:10px;"><button class="btn btn-outline btn-sm" onclick="viewMaterial('${m.id}')"><i class="fas fa-eye"></i> Ver</button><button class="btn btn-outline btn-sm" style="border-color:#ef4444;color:#ef4444;" onclick="deleteMaterial('${m.id}')"><i class="fas fa-trash"></i> Apagar</button></div></div>`).join("")||'<p class="text-muted" style="text-align:center;">Sem materiais</p>';}
function matIcon(t){return ({pdf:"file-pdf",video:"video",audio:"volume-up",slide:"presentation",slides:"presentation"}[String(t||"").toLowerCase()]||"file");}
function updateCoursesList(){const l=id("coursesList");if(!l)return;if(data.courses.length){l.innerHTML=data.courses.map(c=>`<div class="list-item"><div class="list-info"><h4>${esc(c.name)}</h4><div class="list-meta"><span><i class="fas fa-users"></i> ${c.students} alunos</span><span><i class="fas fa-clock"></i> ${esc(c.nextClass)}</span></div></div><button class="btn btn-outline btn-sm" onclick="manageCourse('${c.id}')"><i class="fas fa-cog"></i></button></div>`).join("");return;}const suggestions=data.availableCourses.slice(0,6).map(c=>`<div class="list-item"><div class="list-info"><h4>${esc(c.name)}</h4><div class="list-meta"><span>Curso disponível para solicitação</span></div></div><button class="btn btn-outline btn-sm" onclick="openRequestForCourse('${c.id}')"><i class="fas fa-paper-plane"></i> Solicitar</button></div>`).join("");l.innerHTML=suggestions||'<p class="text-muted" style="text-align:center;">Sem cursos atribuídos. Use "Solicitar Curso".</p>';}
function updateCourseStudents(){const l=id("courseStudentsList");if(!l)return;const filter=id("courseStudentsFilter")?.value||"all";const list=filter==="all"?data.students:data.students.filter(s=>String(s.courseId)===String(filter));const items=list.map(s=>`<div class="list-item"><div class="list-info"><h4>${esc(s.name)}</h4><div class="list-meta"><span>${esc(s.email)}</span><span>${esc(s.courseTitle||"-")}</span><span>Progresso: ${esc(s.progress)}%</span><span>Nível: ${esc(s.level||"iniciante")}</span></div></div><div style="display:flex;gap:8px;"><button class="btn btn-outline btn-sm" onclick="openStudentMessage('${esc(s.email)}')">Mensagem</button><button class="btn btn-outline btn-sm" onclick="openProgressModal('${esc(s.id)}')">Progresso</button></div></div>`).join("");l.innerHTML=items||'<p class="text-muted" style="text-align:center;">Sem alunos inscritos</p>';}
function updateSchedule(){const key=new Date().toDateString();const today=data.schedule.filter(s=>{const d=s.rawDate?new Date(s.rawDate):null;return d&&d.toDateString()===key&&!dismissedSchedule.has(String(s.id));});id("todaySchedule").innerHTML=today.map(s=>`<div class="list-item"><div class="list-info"><h4>${esc(s.course)}</h4><div class="list-meta"><span><i class="fas fa-clock"></i> ${esc(s.time)}</span><span><i class="fas fa-link"></i> ${s.meetingLink?"Link ativo":"Sem link"}</span></div></div><div style="display:flex;gap:8px;align-items:center;"><span class="text-small" style="background:${s.type==="Ao Vivo"?"#e0f7fa":"#fff3cd"};color:${s.type==="Ao Vivo"?"#006064":"#856404"};padding:4px 8px;border-radius:4px;">${esc(s.type)}</span><button class="btn btn-outline btn-sm" onclick="deleteLiveClass('${s.id}')">Apagar</button></div></div>`).join("")||'<p class="text-muted" style="text-align:center;padding:20px;">Nenhuma aula agendada</p>';
id("scheduledClasses").innerHTML=data.schedule.map(s=>`<div class="list-item"><div class="list-info"><h4>${esc(s.title)}</h4><div class="list-meta"><span><i class="fas fa-book"></i> ${esc(s.course)}</span><span><i class="fas fa-clock"></i> ${esc(s.time)}</span><span><i class="fas fa-check"></i> ${esc(s.approval)}</span></div></div><div style="display:flex;gap:8px;"><button class="btn btn-outline btn-sm" onclick="viewLiveClassInfo('${s.id}')"><i class="fas fa-eye"></i> Ver</button><button class="btn btn-outline btn-sm" onclick="cancelLiveClass('${s.id}')">Cancelar</button><button class="btn btn-outline btn-sm" onclick="deleteLiveClass('${s.id}')">Apagar</button></div></div>`).join("")||'<p class="text-muted" style="text-align:center;">Sem aulas</p>';
}
function updateMessages(){const inboxFiltered=data.inboxMessages.filter(m=>!dismissedInbox.has(String(m.id)));const sentFiltered=data.messages.filter(m=>!dismissedSent.has(String(m.id)));const inbox=inboxFiltered.map(m=>`<div class="list-item"><div class="list-info"><h4>${esc(m.subject||"Mensagem")}</h4><div class="list-meta"><span>De: ${esc(m.from||"Admin")}</span><span>${esc((m.created_at||"").replace("T"," ").slice(0,16))}</span></div></div><div style="display:flex;gap:8px;"><button class="btn btn-outline btn-sm" onclick="viewInboxMessage('${m.id}')"><i class="fas fa-eye"></i></button><button class="btn btn-outline btn-sm" onclick="replyInboxMessage('${m.id}')">Responder</button><button class="btn btn-outline btn-sm" onclick="dismissInboxMessage('${m.id}')">Apagar</button></div></div>`).join("")||'<p class="text-muted" style="text-align:center;padding:12px;">Sem mensagens recebidas</p>';const sent=sentFiltered.map(m=>`<div class="list-item"><div class="list-info"><h4>${esc(m.subject)}</h4><div class="list-meta"><span>Para: ${esc(m.to)}</span><span>${esc(m.date)}</span></div></div><div style="display:flex;gap:8px;"><button class="btn btn-outline btn-sm" onclick="viewSentMessage('${m.id}')"><i class="fas fa-eye"></i></button><button class="btn btn-outline btn-sm" onclick="deleteSentMessage('${m.id}')">Apagar</button></div></div>`).join("")||'<p class="text-muted" style="text-align:center;padding:12px;">Sem mensagens enviadas</p>';id("inboxMessages").innerHTML=inbox;id("sentMessages").innerHTML=sent;}
function updateChatGroups(){id("chatGroupsList").innerHTML=data.chatGroups.map(g=>`<div class="list-item"><div class="list-info"><h4>${esc(g.name)}</h4><div class="list-meta"><span>Curso: ${esc(g.course)}</span><span>Status: ${esc(g.status)}</span><span>${esc((g.createdAt||"").slice(0,10))}</span></div></div><div style="display:flex;gap:8px;"><button class="btn btn-outline btn-sm" onclick="viewChatGroup('${g.id}')"><i class="fas fa-eye"></i></button><button class="btn btn-outline btn-sm" onclick="viewChatGroupMessages('${g.id}')">Mensagens</button></div></div>`).join("")||'<p class="text-muted" style="text-align:center;">Nenhum grupo de chat</p>';}
function initDashboard(){refreshStats();populateCourseOptions();refreshMessageTargetOptions();updateMaterialsGrid("recentMaterials",data.materials.slice(0,4));updateMaterialsGrid("allMaterials",data.materials);updateCoursesList();const filter=id("courseStudentsFilter");if(filter){const opts=['<option value="all">Todos os cursos</option>'].concat(data.courses.map(c=>`<option value="${c.id}">${esc(c.name)}</option>`)).join("");filter.innerHTML=opts;filter.onchange=updateCourseStudents;}updateCourseStudents();updateSchedule();updateMessages();updateChatGroups();}
function initNavigation(){const nav=document.querySelectorAll(".nav-item[data-section]");const sections=document.querySelectorAll(".section");nav.forEach(item=>{item.addEventListener("click",e=>{e.preventDefault();const sec=item.getAttribute("data-section");nav.forEach(n=>n.classList.remove("active"));item.classList.add("active");sections.forEach(s=>s.classList.add("hidden"));id(sec+"Section")?.classList.remove("hidden");const title=id("pageTitle");if(title)title.textContent=({dashboard:"Dashboard",courses:"Meus Cursos",materials:"Materiais",live:"Aulas Ao Vivo",messages:"Mensagens",calendar:"Calendário"}[sec]||"Dashboard");if(sec==="messages"){data.inboxMessages.forEach(m=>readMsg.add(String(m.id)));data.notifications.forEach(n=>readNotif.add(String(n.id)));saveRead();refreshNotificationBadges();}if(window.innerWidth<=1024)id("sidebar")?.classList.remove("active");});});}
function openMessageComposer(){const nav=document.querySelector('.nav-item[data-section="messages"]');if(nav){nav.click();}const subject=id("messageSubject");if(subject){subject.focus();}}
function openStudentMessage(email){const nav=document.querySelector('.nav-item[data-section="messages"]');if(nav){nav.click();}const to=id("messageTo");if(to)to.value="student";refreshMessageTargetOptions();const target=id("messageTargetValue");if(target){target.value=email;}const subject=id("messageSubject");if(subject){subject.focus();}}
async function startLiveClass(){
  const first=data.courses[0];
  const name=first?first.name:"Aula Rápida";
  confirmAction("Confirmar aula ao vivo",`<p>Deseja criar a aula ao vivo para: <strong>${esc(name)}</strong>?</p>`,async()=>{
    try{
      const body={
        title:first?`Aula: ${first.name}`:"Aula Rápida",
        description:first?`Aula do curso ${first.name}.`:"Aula ao vivo da plataforma.",
        scheduled_at:new Date().toISOString(),
        visibility:"public",
        duration_minutes:60,
        capacity:25,
        level:"intermediario",
        content:["Abertura e objetivos","Exercicios praticos","Perguntas e respostas"],
        support_materials:[]
      };
      if(first)body.course_id=first.id;
      const r=await api("/professor/live-classes",{method:"POST",body:JSON.stringify(body)});
      await loadData();initDashboard();
      info("Aula iniciada",`<p>Link da aula: <a href="${esc(r.liveClass.meeting_link)}">${esc(r.liveClass.meeting_link)}</a></p><p>Estado: aguardando aprovação do admin.</p>`);
      showAlert("Aula criada e enviada para aprovação");
    }catch(e){showAlert(e.message,"error");}
  });
}
async function startCourseClass(courseId){const c=data.courses.find(x=>x.id===courseId);if(!c)return;try{const r=await api("/professor/live-classes",{method:"POST",body:JSON.stringify({course_id:c.id,title:`Aula: ${c.name}`,description:`Aula do curso ${c.name}.`,scheduled_at:new Date().toISOString(),visibility:"enrolled",duration_minutes:60,capacity:25,level:"intermediario",content:["Abertura e objetivos","Exercicios praticos","Perguntas e respostas"],support_materials:[]})});await loadData();initDashboard();info("Aula do curso criada",`<p>Curso: ${esc(c.name)}</p><p>Link: <a href="${esc(r.liveClass.meeting_link)}">${esc(r.liveClass.meeting_link)}</a></p><p>Estado: aguardando aprovação do admin.</p>`);showAlert("Aula do curso enviada para aprovação");}catch(e){showAlert(e.message,"error");}}
async function scheduleClass(){const cid=id("scheduleCourse").value;const dtv=id("scheduleDateTime").value;const vis=id("scheduleVisibility")?.value||"public";const duration=Number(id("scheduleDuration")?.value||0);const capacity=Number(id("scheduleCapacity")?.value||0);const level=id("scheduleLevel")?.value||"intermediario";const contentRaw=(id("scheduleContent")?.value||"").trim();const materialsRaw=(id("scheduleMaterials")?.value||"").trim();const contentList=contentRaw?contentRaw.split("\n").map(s=>s.trim()).filter(Boolean):[];const materialsList=materialsRaw?materialsRaw.split("\n").map(s=>s.trim()).filter(Boolean):[];if(!cid||!dtv){showAlert("Selecione curso e data/hora","error");if(!data.courses.length){openModal("courseRequestModal");}return;}if(!duration||duration<10){showAlert("Defina a duração da aula","error");return;}if(!capacity||capacity<1){showAlert("Defina o número de vagas","error");return;}if(!contentList.length){showAlert("Informe o conteúdo da aula","error");return;}const c=data.courses.find(x=>x.id===cid);if(!c){showAlert("Curso inválido","error");return;}try{await api("/professor/live-classes",{method:"POST",body:JSON.stringify({course_id:c.id,title:`Aula agendada: ${c.name}`,description:`Aula do curso ${c.name}.`,scheduled_at:new Date(dtv).toISOString(),visibility:vis,duration_minutes:duration,capacity,level,content:contentList,support_materials:materialsList})});await loadData();initDashboard();closeModal("scheduleModal");id("scheduleDateTime").value="";if(id("scheduleContent"))id("scheduleContent").value="";if(id("scheduleMaterials"))id("scheduleMaterials").value="";showAlert("Aula agendada e enviada para aprovação");}catch(e){showAlert(e.message,"error");}}
async function uploadMaterial(){const title=id("materialTitle").value.trim();const type=id("materialType").value;const cid=id("materialCourse").value||null;const file=id("materialFile").files[0];const vis=id("materialVisibility")?.value||"public";if(!title||!file){showAlert("Preencha t?tulo e selecione arquivo","error");return;}if(!data.courses.length){showAlert("Sem cursos atribuidos. Solicite um curso antes de enviar materiais.","error");openModal("courseRequestModal");return;}try{await api("/professor/materials",{method:"POST",body:JSON.stringify({course_id:cid,title,type,file_name:file.name,visibility:vis})});await loadData();initDashboard();closeModal("uploadModal");id("materialTitle").value="";id("materialFile").value="";showAlert("Material enviado para aprova??o");}catch(e){showAlert(e.message,"error");}}
async function sendMessage(){const tt=id("messageTo").value;const tv=id("messageTargetValue")?.value||"";const subject=id("messageSubject").value.trim();const content=id("messageContent").value.trim();if(!subject||!content){showAlert("Preencha assunto e mensagem","error");return;}if((tt==="course"||tt==="student")&&!tv){showAlert("Selecione o destinatário específico","error");return;}try{await api("/professor/messages",{method:"POST",body:JSON.stringify({target_type:tt,target_value:tt==="all"?null:tv,subject,content})});await loadData();initDashboard();id("messageSubject").value="";id("messageContent").value="";if(id("messageTargetValue"))id("messageTargetValue").value="";showAlert("Mensagem enviada");}catch(e){showAlert(e.message,"error");}}
async function createChatGroup(){const name=id("chatGroupName").value.trim();const course=id("chatGroupCourse")?.value||null;if(!name){showAlert("Informe o nome do grupo","error");return;}try{await api("/professor/chat-groups",{method:"POST",body:JSON.stringify({name,course_id:course||null})});await loadData();initDashboard();closeModal("chatGroupModal");id("chatGroupName").value="";if(id("chatGroupCourse"))id("chatGroupCourse").value="";showAlert("Grupo criado e enviado para aprovação do admin");}catch(e){showAlert(e.message,"error");}}
async function submitCourseRequest(){const courseId=id("requestCourse")?.value||"";const notes=(id("requestCourseNotes")?.value||"").trim();if(!courseId){showAlert("Selecione o curso","error");return;}try{await api("/professor/course-requests",{method:"POST",body:JSON.stringify({course_id:courseId,notes})});closeModal("courseRequestModal");if(id("requestCourseNotes"))id("requestCourseNotes").value="";showAlert("Pedido enviado ao administrador");}catch(e){showAlert(e.message,"error");}}
function viewMaterial(mid){const m=data.materials.find(x=>x.id===mid);if(!m)return;info("Detalhes do material",`<p><strong>Título:</strong> ${esc(m.name)}</p><p><strong>Tipo:</strong> ${esc(m.type)}</p><p><strong>Curso:</strong> ${esc(m.course)}</p><p><strong>Arquivo:</strong> ${esc(m.file)}</p><p><strong>Visibilidade:</strong> ${m.visibility==="enrolled"?"Somente inscritos":"Todos"}</p><p><strong>Status:</strong> ${esc(m.status)}</p><p><strong>Data:</strong> ${esc(m.date)}</p>`);} 
function manageCourse(cid){const c=data.courses.find(x=>x.id===cid);if(!c)return;info("Gerenciar curso",`<p><strong>Curso:</strong> ${esc(c.name)}</p><p><strong>Alunos:</strong> ${c.students}</p><p><strong>Ação rápida:</strong> Use <em>Iniciar</em> na seção de Aulas ao Vivo para abrir sala deste curso.</p>`);} function openRequestForCourse(courseId){const req=id("requestCourse");if(req)req.value=courseId||"";openModal("courseRequestModal");}async function deleteMaterial(mid){const m=data.materials.find(x=>x.id===mid);if(!m)return;confirmAction("Apagar material",`<p>Deseja apagar o material <strong>${esc(m.name)}</strong>?</p>`,async()=>{try{await api(`/professor/materials/${mid}`,{method:"DELETE"});await loadData();initDashboard();showAlert("Material apagado");}catch(e){showAlert(e.message,"error");}});} 
function viewLiveClassInfo(idv){const x=data.schedule.find(s=>s.id===idv);if(!x)return;const contentHtml=x.content.length?`<ul>${x.content.map(i=>`<li>${esc(i)}</li>`).join("")}</ul>`:"<p>-</p>";const matsHtml=x.materials.length?`<ul>${x.materials.map(i=>`<li>${esc(i)}</li>`).join("")}</ul>`:"<p>-</p>";info("Detalhes da aula",`<p><strong>Título:</strong> ${esc(x.title)}</p><p><strong>Curso:</strong> ${esc(x.course)}</p><p><strong>Descrição:</strong> ${esc(x.description||"-")}</p><p><strong>Horário:</strong> ${esc(x.time)}</p><p><strong>Duração:</strong> ${esc(x.duration)} minutos</p><p><strong>Vagas:</strong> 0/${esc(x.capacity)} preenchidas</p><p><strong>Nível:</strong> ${esc(x.level)}</p><p><strong>Status:</strong> ${esc(x.status)}</p><p><strong>Aprovação:</strong> ${esc(x.approval)}</p><p><strong>Conteúdo:</strong> ${contentHtml}</p><p><strong>Materiais:</strong> ${matsHtml}</p><p><strong>Link:</strong> ${x.meetingLink?`<a href="${esc(x.meetingLink)}">Entrar</a>`:"Não disponível"}</p>`);} 
function viewChatGroup(idv){const g=data.chatGroups.find(x=>x.id===idv);if(!g)return;info("Detalhes do grupo",`<p><strong>Nome:</strong> ${esc(g.name)}</p><p><strong>Curso:</strong> ${esc(g.course)}</p><p><strong>Status:</strong> ${esc(g.status)}</p><p><strong>Criado em:</strong> ${esc((g.createdAt||"").slice(0,10))}</p>`);} 
async function viewChatGroupMessages(idv){const g=data.chatGroups.find(x=>x.id===idv);if(!g)return;try{const res=await api(`/chat/groups/${idv}/messages`);const msgs=(res.messages||[]).map(m=>`<div style="margin-bottom:10px;"><strong>${esc(m.sender_name||"Utilizador")}</strong><br>${esc(m.content)}<br><small class="text-muted">${esc((m.created_at||"").replace("T"," ").slice(0,16))}</small></div>`).join("")||"<p class=\"text-muted\">Sem mensagens neste grupo.</p>";info(`Mensagens do grupo: ${esc(g.name)}`,`${msgs}<div style="margin-top:12px;"><textarea id="chatGroupReply" class="form-control" rows="3" placeholder="Escreva uma mensagem..."></textarea><button class="btn btn-primary w-100 mt-2" onclick="sendChatGroupMessage('${g.id}')">Enviar mensagem</button></div>`);}catch(e){showAlert(e.message,"error");}}
async function sendChatGroupMessage(idv){const input=id("chatGroupReply");const content=(input?.value||"").trim();if(!content){showAlert("Digite a mensagem","error");return;}try{await api(`/chat/groups/${idv}/messages`,{method:"POST",body:JSON.stringify({content})});if(input)input.value="";await viewChatGroupMessages(idv);}catch(e){showAlert(e.message,"error");}}
function viewInboxMessage(idv){const m=data.inboxMessages.find(x=>String(x.id)===String(idv));if(!m)return;info("Mensagem recebida",`<p><strong>De:</strong> ${esc(m.from||"Admin")}</p><p><strong>Assunto:</strong> ${esc(m.subject||"Mensagem")}</p><p><strong>Data:</strong> ${esc((m.created_at||"").replace("T"," ").slice(0,16))}</p><p>${esc(m.content||"")}</p>`);}
function replyInboxMessage(idv){const m=data.inboxMessages.find(x=>String(x.id)===String(idv));if(!m)return;openMessageComposer();if(id("messageSubject"))id("messageSubject").value=`Re: ${m.subject||"Mensagem"}`;}
function dismissInboxMessage(idv){dismissedInbox.add(String(idv));saveDismissed();updateMessages();}
function viewSentMessage(idv){const m=data.messages.find(x=>String(x.id)===String(idv));if(!m)return;info("Mensagem enviada",`<p><strong>Para:</strong> ${esc(m.to)}</p><p><strong>Assunto:</strong> ${esc(m.subject)}</p><p><strong>Data:</strong> ${esc(m.date)}</p><p>${esc(m.content||"")}</p>`);}
function openProgressModal(enrollmentId){const s=data.students.find(x=>String(x.id)===String(enrollmentId));if(!s)return;id("progressEnrollmentId").value=s.id;id("progressValue").value=String(s.progress||10);id("progressLevel").value=s.level||"iniciante";openModal("progressModal");}
async function saveStudentProgress(){const enrollmentId=id("progressEnrollmentId").value;const progress=Number(id("progressValue").value||0);const level=id("progressLevel").value||"iniciante";if(!enrollmentId){showAlert("Inscricao invalida","error");return;}if(Number.isNaN(progress)||progress<0||progress>100){showAlert("Progresso deve estar entre 0 e 100","error");return;}try{await api(`/professor/enrollments/${enrollmentId}/progress`,{method:"PATCH",body:JSON.stringify({progress,level})});await loadData();initDashboard();closeModal("progressModal");showAlert("Progresso atualizado");}catch(e){showAlert(e.message,"error");}}
async function deleteSentMessage(idv){const m=data.messages.find(x=>String(x.id)===String(idv));if(!m)return;confirmAction("Apagar mensagem",`<p>Deseja apagar a mensagem "<strong>${esc(m.subject)}</strong>"?</p>`,async()=>{try{await api(`/professor/messages/${idv}`,{method:"DELETE"});dismissedSent.add(String(idv));saveDismissed();await loadData();initDashboard();showAlert("Mensagem apagada");}catch(e){showAlert(e.message,"error");}});}
function clearTodaySchedule(){const key=new Date().toDateString();data.schedule.forEach(s=>{const d=s.rawDate?new Date(s.rawDate):null;if(d&&d.toDateString()===key)dismissedSchedule.add(String(s.id));});saveDismissedSchedule();updateSchedule();}
async function cancelLiveClass(idv){const s=data.schedule.find(x=>x.id===idv);if(!s)return;confirmAction("Cancelar aula",`<p>Deseja cancelar a aula <strong>${esc(s.title)}</strong>?</p>`,async()=>{try{await api(`/professor/live-classes/${idv}`,{method:"PATCH",body:JSON.stringify({status:"cancelled"})});await loadData();initDashboard();showAlert("Aula cancelada");}catch(e){showAlert(e.message,"error");}});}
async function deleteLiveClass(idv){const s=data.schedule.find(x=>x.id===idv);if(!s)return;confirmAction("Apagar aula",`<p>Deseja apagar a aula <strong>${esc(s.title)}</strong>? Esta ação é permanente.</p>`,async()=>{try{await api(`/professor/live-classes/${idv}`,{method:"DELETE"});await loadData();initDashboard();showAlert("Aula apagada");}catch(e){showAlert(e.message,"error");}});}
function getActiveSection(){return document.querySelector(".nav-item.active[data-section]")?.getAttribute("data-section")||"dashboard";}
function refreshVisibleSection(){const sec=getActiveSection();refreshNotificationBadges();if(sec==="dashboard"){refreshStats();updateSchedule();updateMaterialsGrid("recentMaterials",data.materials.slice(0,4));return;}if(sec==="courses"){updateCoursesList();updateCourseStudents();return;}if(sec==="materials"){updateMaterialsGrid("allMaterials",data.materials);return;}if(sec==="live"){updateSchedule();return;}if(sec==="messages"){refreshMessageTargetOptions();updateMessages();updateChatGroups();return;}if(sec==="calendar"){updateSchedule();}}function bind(){id("menuToggle")?.addEventListener("click",()=>id("sidebar").classList.toggle("active"));id("logoutBtn")?.addEventListener("click",()=>{localStorage.removeItem("token");sessionStorage.removeItem("token");localStorage.removeItem("user");sessionStorage.removeItem("user");localStorage.removeItem("admin_token");location.href="login.html";});id("startLiveBtn")?.addEventListener("click",startLiveClass);id("messageTo")?.addEventListener("change",refreshMessageTargetOptions);window.addEventListener("click",e=>{if(e.target.classList.contains("modal"))e.target.style.display="none";});document.querySelector(".main")?.addEventListener("click",()=>{if(window.innerWidth<=1024)id("sidebar").classList.remove("active");});}
window.openModal=openModal;window.closeModal=closeModal;window.startLiveClass=startLiveClass;window.startCourseClass=startCourseClass;window.scheduleClass=scheduleClass;window.uploadMaterial=uploadMaterial;window.sendMessage=sendMessage;window.manageCourse=manageCourse;window.openRequestForCourse=openRequestForCourse;window.viewMaterial=viewMaterial;window.deleteMaterial=deleteMaterial;window.createChatGroup=createChatGroup;window.viewLiveClassInfo=viewLiveClassInfo;window.viewChatGroup=viewChatGroup;window.viewChatGroupMessages=viewChatGroupMessages;window.sendChatGroupMessage=sendChatGroupMessage;window.openMessageComposer=openMessageComposer;window.openStudentMessage=openStudentMessage;window.submitCourseRequest=submitCourseRequest;window.clearTodaySchedule=clearTodaySchedule;window.cancelLiveClass=cancelLiveClass;window.deleteLiveClass=deleteLiveClass;window.viewInboxMessage=viewInboxMessage;window.replyInboxMessage=replyInboxMessage;window.dismissInboxMessage=dismissInboxMessage;window.viewSentMessage=viewSentMessage;window.deleteSentMessage=deleteSentMessage;window.openProgressModal=openProgressModal;window.saveStudentProgress=saveStudentProgress;
document.addEventListener("DOMContentLoaded",async()=>{initNavigation();bind();try{await loadData();maybePopupRealtime();initDashboard();setInterval(async()=>{if(document.hidden||polling)return;polling=true;try{await loadData();maybePopupRealtime();refreshVisibleSection();}catch{}finally{polling=false;}},20000);document.addEventListener("visibilitychange",()=>{if(!document.hidden){loadData().then(()=>{maybePopupRealtime();refreshVisibleSection();}).catch(()=>{});}});window.addEventListener("focus",()=>{loadData().then(()=>{maybePopupRealtime();refreshVisibleSection();}).catch(()=>{});});}catch(e){showAlert(e.message||"Falha ao carregar dados","error");}});
})();











