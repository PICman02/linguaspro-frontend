const API_BASE = window.__API_URL__ || window.API_URL || "http://localhost:5001/api";  let PROFESSORS = [];  const container = document.getElementById("professorsContainer"); const modalsContainer = document.getElementById("professorsModals"); const searchInput = document.getElementById("searchInput"); const categoryFilter = document.getElementById("categoryFilter"); const ratingFilter = document.getElementById("ratingFilter"); const availabilityFilter = document.getElementById("availabilityFilter"); const applyTeacherBtn = document.getElementById("applyTeacherBtn");  const countStat = document.getElementById("professorsCountStat"); const languagesStat = document.getElementById("professorsLanguagesStat"); const experienceStat = document.getElementById("professorsExperienceStat"); const countBadge = document.getElementById("professorsCountBadge");  function escapeHtml(value) {  return String(value || "")   .replace(/&/g, "&amp;")   .replace(/</g, "&lt;")   .replace(/>/g, "&gt;")   .replace(/\"/g, "&quot;")   .replace(/'/g, "&#039;"); }  function normalizeCategory(profession, skills) {  const text = `${profession || ""} ${(skills || []).join(" ")}`.toLowerCase();  if (text.includes("ingles")) return "ingles";  if (text.includes("portugues")) return "portugues";  if (text.includes("espanhol")) return "espanhol";  if (text.includes("frances")) return "frances";  if (text.includes("alemao")) return "alemao";  if (text.includes("mandarim")) return "mandarim";  return "ingles"; }  function availabilityFromExperience(experience) {  const value = String(experience || "").toLowerCase();  if (value === "junior" || value === "estagiario") return "manha";  if (value === "pleno") return "tarde";  return "noite"; }  function experienceToYears(experience) {  const value = String(experience || "").toLowerCase();  if (value === "estagiario") return 1;  if (value === "junior") return 2;  if (value === "pleno") return 4;  if (value === "senior") return 7;  if (value === "especialista") return 10;  return 3; }  function scoreFromProfessor(professor) {  const years = experienceToYears(professor.experience);  const activity = Number(professor.materials_count || 0) + Number(professor.live_classes_count || 0);  return Math.min(5, Number((3.8 + years * 0.12 + activity * 0.08).toFixed(1))); }  function formatDate(dateLike) {  if (!dateLike) return "-";  const date = new Date(dateLike);  if (Number.isNaN(date.getTime())) return "-";  return date.toLocaleDateString("pt-PT"); }  function normalizeSkills(skills) {  if (Array.isArray(skills)) return skills.map((item) => String(item)).filter(Boolean);  return []; }  function toUiProfessor(item) {  const skills = normalizeSkills(item.skills);  const category = normalizeCategory(item.profession, skills);  const availability = availabilityFromExperience(item.experience);  const years = experienceToYears(item.experience);   return {   id: item.id,   name: item.name || "Professor",   email: item.email || "-",   phone: item.phone || "-",   profession: item.profession || "-",   experience: item.experience || "-",   experienceYears: years,   education: item.education || "-",   skills,   objective: item.objective || "Professor cadastrado na plataforma.",   createdAt: item.created_at,   materialsCount: Number(item.materials_count || 0),   liveClassesCount: Number(item.live_classes_count || 0),   category,   availability,   score: scoreFromProfessor(item),  courses,  }; }  function renderCard(prof) {  const initials = prof.name   .split(" ")   .filter(Boolean)   .slice(0, 2)   .map((part) => part[0])   .join("")   .toUpperCase();   const topSkills = prof.skills.slice(0, 3).map((skill) => `<span class="badge bg-light text-dark me-1 mb-1">${escapeHtml(skill)}</span>`).join("");   return `   <div class="col-md-6 col-lg-4 professor-item" data-id="${escapeHtml(prof.id)}" data-category="${escapeHtml(prof.category)}" data-rating="${prof.score}" data-availability="${escapeHtml(prof.availability)}">    <div class="card h-100 border-0 shadow-sm professor-card">     <div class="card-body">      <div class="d-flex align-items-center mb-3">       <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-3" style="width:48px;height:48px;font-weight:700;">${escapeHtml(initials)}</div>       <div>        <h5 class="card-title mb-0">${escapeHtml(prof.name)}</h5>        <small class="text-muted">${escapeHtml(prof.profession || prof.category)}</small>       </div>      </div>       <p class="text-muted small mb-2">${escapeHtml(prof.objective)}</p>      <p class="mb-1"><strong>Idioma:</strong> ${escapeHtml(prof.category)}</p>      <p class="mb-1"><strong>Disponibilidade:</strong> ${escapeHtml(prof.availability)}</p>      <p class="mb-2"><strong>Score:</strong> ${prof.score}</p>       <div class="mb-3">${topSkills || '<span class="badge bg-light text-dark">Sem skills</span>'}</div>       <div class="d-flex justify-content-between align-items-center">       <small class="text-muted">Materiais: ${prof.materialsCount} | Aulas: ${prof.liveClassesCount}</small>       <button type="button" class="btn btn-sm btn-outline-primary" data-professor-details="${escapeHtml(prof.id)}">Ver detalhes</button>      </div>     </div>    </div>   </div>  `; }  function renderList() {  if (!container) return;  if (!PROFESSORS.length) {   container.innerHTML = `    <div class="col-12">     <div class="alert alert-info text-center">Nenhum professor disponÃ­vel no momento.</div>    </div>   `;   updateStats();   if (countBadge) countBadge.textContent = "0";   return;  }  container.innerHTML = PROFESSORS.map(renderCard).join("");  bindDetailsButtons();  applyFilters();  updateStats(); }  function updateStats() {  const total = PROFESSORS.length;  const languageCount = new Set(PROFESSORS.map((prof) => prof.category)).size;  const avgExperience = total   ? (PROFESSORS.reduce((acc, prof) => acc + Number(prof.experienceYears || 0), 0) / total).toFixed(1)   : "0";   if (countStat) countStat.textContent = String(total);  if (languagesStat) languagesStat.textContent = String(languageCount);  if (experienceStat) experienceStat.textContent = String(avgExperience); }  function updateVisibleCount() {  const visible = Array.from(document.querySelectorAll(".professor-item")).filter((item) => item.style.display !== "none").length;  if (countBadge) countBadge.textContent = String(visible); }  function applyFilters() {  const text = (searchInput?.value || "").toLowerCase();  const category = categoryFilter?.value || "all";  const rating = Number(ratingFilter?.value || 0);  const availability = availabilityFilter?.value || "all";   document.querySelectorAll(".professor-item").forEach((item) => {   const name = item.querySelector(".card-title")?.textContent?.toLowerCase() || "";   const bio = item.querySelector(".text-muted")?.textContent?.toLowerCase() || "";   const itemCategory = item.dataset.category || "";   const itemRating = Number(item.dataset.rating || 0);   const itemAvailability = item.dataset.availability || "";    const okText = !text || name.includes(text) || bio.includes(text);   const okCategory = category === "all" || category === itemCategory;   const okRating = itemRating >= rating;   const okAvailability = availability === "all" || availability === itemAvailability;    item.style.display = okText && okCategory && okRating && okAvailability ? "" : "none";  });   updateVisibleCount(); }  function ensureDetailsModal() {  if (!modalsContainer) return null;   let modalEl = document.getElementById("professorDetailsModal");  if (modalEl) return modalEl;   modalsContainer.innerHTML = `   <div class="modal fade" id="professorDetailsModal" tabindex="-1" aria-hidden="true">    <div class="modal-dialog modal-lg modal-dialog-centered">     <div class="modal-content">      <div class="modal-header">       <h5 class="modal-title">Detalhes do Professor</h5>       <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>      </div>      <div class="modal-body" id="professorDetailsBody"></div>     </div>    </div>   </div>  `;   modalEl = document.getElementById("professorDetailsModal");  return modalEl; }  function renderDetailsBody(prof) {  const skills = prof.skills.length   ? prof.skills.map((skill) => `<span class="badge bg-secondary me-1 mb-1">${escapeHtml(skill)}</span>`).join("")   : "<span class=\"text-muted\">Sem skills informadas.</span>";  const courses = prof.courses?.length ? prof.courses.map((course) => `<span class="badge bg-light text-dark me-1 mb-1">${escapeHtml(course)}</span>`).join("") : "<span class=\"text-muted\">Sem cursos associados.</span>";   return `   <div class="row g-3">    <div class="col-md-6"><strong>Nome:</strong><br>${escapeHtml(prof.name)}</div>    <div class="col-md-6"><strong>Email:</strong><br>${escapeHtml(prof.email)}</div>    <div class="col-md-6"><strong>Telefone:</strong><br>${escapeHtml(prof.phone)}</div>    <div class="col-md-6"><strong>Ã¡rea principal:</strong><br>${escapeHtml(prof.profession)}</div>    <div class="col-md-6"><strong>ExperiÃªncia:</strong><br>${escapeHtml(prof.experience)} (${prof.experienceYears} anos)</div>    <div class="col-md-6"><strong>FormaÃ§Ã£o:</strong><br>${escapeHtml(prof.education)}</div>    <div class="col-md-6"><strong>Materiais publicados:</strong><br>${prof.materialsCount}</div>    <div class="col-md-6"><strong>Aulas ao vivo:</strong><br>${prof.liveClassesCount}</div>    <div class="col-12"><strong>Cursos lecionados:</strong><br>${courses}</div>    <div class="col-12"><strong>Skills:</strong><br>${skills}</div>    <div class="col-12"><strong>Objetivo profissional:</strong><br>${escapeHtml(prof.objective)}</div>    <div class="col-12 text-muted"><small>Perfil ativo desde ${escapeHtml(formatDate(prof.createdAt))}</small></div>   </div>  `; }  function openProfessorDetails(professorId) {  const prof = PROFESSORS.find((item) => String(item.id) === String(professorId));  if (!prof) return;   const modalEl = ensureDetailsModal();  if (!modalEl || !window.bootstrap) return;   const body = document.getElementById("professorDetailsBody");  if (!body) return;  body.innerHTML = renderDetailsBody(prof);   const modal = window.bootstrap.Modal.getOrCreateInstance(modalEl);  modal.show(); }  function bindDetailsButtons() {  document.querySelectorAll("[data-professor-details]").forEach((button) => {   button.addEventListener("click", () => {    openProfessorDetails(button.getAttribute("data-professor-details"));   });  }); }  async function loadRealProfessors() {  try {   const response = await fetch(`${API_BASE}/professors`);   const data = await response.json().catch(() => ({}));   if (!response.ok) throw new Error(data.error || "Falha ao carregar professores");    const list = Array.isArray(data.professors) ? data.professors : [];   PROFESSORS = list.map(toUiProfessor);  } catch {   PROFESSORS = [];  } }  document.addEventListener("DOMContentLoaded", async () => {  await loadRealProfessors();  renderList();   [searchInput, categoryFilter, ratingFilter, availabilityFilter].forEach((element) => {   element?.addEventListener("input", applyFilters);   element?.addEventListener("change", applyFilters);  });   applyTeacherBtn?.addEventListener("click", () => {   window.location.href = "apply-teacher.html";  }); });   
