(function(){
const API=window.__API_URL__||window.API_URL||"http://localhost:5001/api";
const st={sec:"dashboard",d:{admin:null,users:[],courses:[],enrollments:[],materials:[],live:[],apps:[],services:[],contacts:[],chat:[],chatRooms:[],messages:[],courseRequests:[],courseAssignments:[]},currentChatGroupId:null,chatMessages:[],charts:{users:null,content:null},chatPoll:null,autoRefreshId:null,realtimeReady:false,lastEventKeys:new Set(),lastScroll:{wy:0,my:0},suppressToastUntil:0};
const r={main:document.getElementById("mainContent"),q:document.getElementById("searchInput")};
const SECTION_KEY="admin_active_section";
const id=(x)=>document.getElementById(x);
const esc=(v)=>String(v||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m]));
const dt=(v)=>{if(!v)return"-";const d=new Date(v);return Number.isNaN(d)?"-":d.toLocaleString("pt-PT",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"});};
const lbl=(s)=>({approved:"Aprovado",rejected:"Rejeitado",pending:"Pendente",scheduled:"Agendada",live:"Ao vivo",recorded:"Gravada",active:"Ativo",inactive:"Inativo"}[String(s||"pending").toLowerCase()]||"-");
const cls=(s)=>{s=String(s||"pending").toLowerCase();if(["approved","paid","active"].includes(s))return"status-approved";if(["rejected","inactive"].includes(s))return"status-rejected";return"status-pending";};
const tok=()=>localStorage.getItem("admin_token")||"";
const utok=()=>localStorage.getItem("token")||sessionStorage.getItem("token")||"";
const usr=()=>{try{return JSON.parse(localStorage.getItem("user")||sessionStorage.getItem("user")||"null");}catch{return null;}};
function ensure(){if(tok())return;const u=usr();const t=utok();if(t&&u?.role==="Admin"){localStorage.setItem("admin_token",t);return;}location.href="login.html";throw new Error("Sem sessao de admin");}
function clearAuthAndRedirect(msg){try{localStorage.removeItem("token");sessionStorage.removeItem("token");localStorage.removeItem("user");sessionStorage.removeItem("user");localStorage.removeItem("admin_token");}catch{}if(msg)toast(msg,"error");setTimeout(()=>{if(!/login\\.html/i.test(location.pathname))location.href="login.html?reason=expired";},600);}
async function api(path,opt={}){const h={"Content-Type":"application/json",...(opt.headers||{})};const t=tok()||utok();if(t)h.Authorization=`Bearer ${t}`;const ctl=new AbortController();const timeoutMs=15000;const timeout=setTimeout(()=>ctl.abort(),timeoutMs);let res;try{res=await fetch(`${API}${path}`,{...opt,headers:h,signal:ctl.signal});}catch(err){if(err?.name==="AbortError")throw new Error("A requisicao demorou demasiado. Verifique a ligacao.");throw err;}finally{clearTimeout(timeout);}const j=await res.json().catch(()=>({}));if(res.status===401){clearAuthAndRedirect(j.error||"Token invalido ou expirado");throw new Error(j.error||"Token invalido ou expirado");}if(!res.ok)throw new Error(j.error||`HTTP ${res.status}`);return j;}
function openModal(m){const x=id(m);if(x)x.style.display="flex";} function closeModal(m){const x=id(m);if(x)x.style.display="none";if(m==="decisionModal"){id("decisionModalNotes").value="";id("decisionModalSubmit").onclick=null;}}
function toast(msg,t="success"){const z=id("toast");if(!z)return;id("toastTitle").textContent=t==="error"?"Erro":"Sucesso";id("toastMessage").textContent=msg;z.className=`toast show ${t}`;setTimeout(hideToast,2600);} function hideToast(){id("toast")?.classList.remove("show");}
function details(title,html){id("detailsModalTitle").textContent=title;id("detailsModalBody").innerHTML=html;openModal("detailsModal");}
function decide({title,text,btn,run}){id("decisionModalTitle").textContent=title;id("decisionModalText").textContent=text;id("decisionModalSubmit").textContent=btn||"Confirmar";id("decisionModalSubmit").onclick=async()=>{await run((id("decisionModalNotes").value||"").trim());closeModal("decisionModal");};openModal("decisionModal");}
function parseArr(v){if(!v)return[];if(Array.isArray(v))return v;try{const p=JSON.parse(v);return Array.isArray(p)?p:[];}catch{return[];}}
function badges(){const pm=st.d.materials.filter(x=>x.approval_status==="pending").length;const pl=st.d.live.filter(x=>x.approval_status==="pending").length;const pe=st.d.enrollments.filter(x=>x.status==="pending").length;const pr=st.d.apps.filter(x=>x.status==="pending").length+st.d.services.filter(x=>x.status==="pending").length+st.d.contacts.filter(x=>x.status==="new").length;const pc=st.d.chat.length;(id("materialsBadge")||{}).textContent=String(pm);(id("liveBadge")||{}).textContent=String(pl);(id("enrollmentsBadge")||{}).textContent=String(pe);(id("requestsBadge")||{}).textContent=String(pr);(id("chatBadge")||{}).textContent=String(pc);(id("messagesBadge")||{}).textContent=String(st.d.messages.length);}
function head(){const a=st.d.admin;if(!a)return;const iv=(a.name||"AD").split(" ").filter(Boolean).slice(0,2).map(p=>p[0]).join("").toUpperCase();const av=document.querySelector(".avatar");const n=document.querySelector(".user-profile h4");const p=document.querySelector(".user-profile p");if(av)av.textContent=iv||"AD";if(n)n.textContent=a.name||"Administrador";if(p)p.textContent=a.role||"Admin";}
function cMap(){const m=new Map();st.d.enrollments.forEach(e=>m.set(e.course_id,(m.get(e.course_id)||0)+1));return m;}
function loadDismissed(){try{const raw=localStorage.getItem("admin_dismissed_notifications");const arr=raw?JSON.parse(raw):[];st.dismissedNotifications=new Set(arr);}catch{st.dismissedNotifications=new Set();}}function saveDismissed(){try{localStorage.setItem("admin_dismissed_notifications",JSON.stringify([...st.dismissedNotifications]));}catch{}}function dismissNotification(key,btn){st.dismissedNotifications.add(String(key));saveDismissed();st.suppressToastUntil=Date.now()+3000;if(btn){const tr=btn.closest("tr");if(tr)tr.remove();}renderPreserve();}function clearNotifications(){const n=notify();n.forEach(item=>st.dismissedNotifications.add(String(item.k)));saveDismissed();st.suppressToastUntil=Date.now()+3000;const tb=r.main?r.main.querySelector("table tbody"):null;if(tb)tb.innerHTML='<tr><td colspan="4">Sem notificações.</td></tr>';renderPreserve();} function notify(){const a=[];const dismissed=st.dismissedNotifications||new Set();const maxAgeMs=1000*60*60*24*7;const normDate=(d)=>d||new Date().toISOString();const isRecent=(d)=>{if(!d)return false;const t=new Date(d).getTime();if(Number.isNaN(t))return false;return Date.now()-t<=maxAgeMs;};const add=(key,t,m,d)=>{const nd=normDate(d);if(!dismissed.has(key)&&isRecent(nd))a.push({k:key,t,m,d:nd});};st.d.enrollments.filter(x=>x.status==="pending").forEach(x=>add("enroll:"+x.id,"Inscricao",x.student_name+" pendente em "+(x.course_title||x.course_id),x.created_at));st.d.apps.filter(x=>x.status==="pending").forEach(x=>add("app:"+x.id,"Candidatura",x.name+" aguardando aprovacao",x.created_at));st.d.services.filter(x=>x.status==="pending").forEach(x=>add("service:"+x.id,"Servico",x.requester_name+" solicitou "+x.service_name,x.created_at));st.d.contacts.filter(x=>x.status==="new").forEach(x=>add("contact:"+x.id,"Contacto",x.name+" enviou mensagem de contacto",x.created_at));st.d.chat.filter(x=>x.status==="pending").forEach(x=>add("chat:"+x.id,"Chat","Grupo pendente: "+x.name,x.created_at));st.d.live.filter(x=>x.approval_status==="pending").forEach(x=>add("live:"+x.id,"Aula","Aula pendente: "+(x.title||"Aula"),x.created_at||x.scheduled_at));st.d.messages.slice(0,12).forEach(x=>add("msg:"+x.id,"Mensagem",x.subject,x.created_at));(st.d.chatMessages||[]).slice(0,12).forEach(x=>add("chatmsg:"+x.id,"Mensagem no chat",(x.group_name?x.group_name+": ":"")+x.content,x.created_at));return a.sort((x,y)=>new Date(y.d)-new Date(x.d)).slice(0,10);} function popupRealtime(){if(Date.now()<st.suppressToastUntil)return;const events=notify().map((e,i)=>({key:e.k||`${e.t}:${e.d||"-"}:${e.m||"-"}:${i}`,...e}));const nowKeys=new Set(events.map(e=>e.key));if(!st.realtimeReady){st.lastEventKeys=nowKeys;st.realtimeReady=true;if(events.length){toast(`${events.length} notificacao(oes) disponivel(is)`);}return;}const fresh=events.filter(e=>!st.lastEventKeys.has(e.key));if(fresh.length){toast(`${fresh.length} nova(s) notificacao(oes) recebida(s)`);if(st.sec==="dashboard")renderPreserve();}st.lastEventKeys=nowKeys;}
function find(arr,idv){return arr.find(x=>String(x.id)===String(idv));}
function mTable(list){return `<table><thead><tr><th>Título</th><th>Professor</th><th>Curso</th><th>Visibilidade</th><th>Status</th><th>Data</th><th>Acoes</th></tr></thead><tbody>${list.map(m=>`<tr data-search="${esc(`${m.title} ${m.professor_name||""} ${m.course_title||""}`)}"><td>${esc(m.title)}</td><td>${esc(m.professor_name||"-")}</td><td>${esc(m.course_title||"Geral")}</td><td>${m.visibility==="enrolled"?"Inscritos":"Público"}</td><td><span class="status-badge ${cls(m.approval_status)}">${lbl(m.approval_status)}</span></td><td>${dt(m.created_at)}</td><td><div class="action-buttons"><button class="action-btn" style="background:var(--primary);color:white;" onclick="viewMaterial('${m.id}')"><i class="fas fa-eye"></i></button>${m.approval_status==="pending"?`<button class="action-btn" style="background:var(--success);color:white;" onclick="approveMaterial('${m.id}')"><i class="fas fa-check"></i></button><button class="action-btn" style="background:var(--danger);color:white;" onclick="rejectMaterial('${m.id}')"><i class="fas fa-times"></i></button>`:`<button class="action-btn" style="background:var(--warning);color:white;" onclick="setMaterialPending('${m.id}')"><i class="fas fa-undo"></i></button>`}</div></td></tr>`).join("")||`<tr><td colspan="7">Nenhum material.</td></tr>`}</tbody></table>`;}
function lTable(list){return `<table><thead><tr><th>Título</th><th>Professor</th><th>Curso</th><th>Agendada</th><th>Visibilidade</th><th>Aprovação</th><th>Status</th><th>Acoes</th></tr></thead><tbody>${list.map(m=>`<tr data-search="${esc(`${m.title} ${m.professor_name||""} ${m.course_title||""}`)}"><td>${esc(m.title)}</td><td>${esc(m.professor_name||"-")}</td><td>${esc(m.course_title||"Geral")}</td><td>${dt(m.scheduled_at||m.created_at)}</td><td>${m.visibility==="enrolled"?"Inscritos":"Público"}</td><td><span class="status-badge ${cls(m.approval_status)}">${lbl(m.approval_status)}</span></td><td><span class="status-badge ${cls(m.status)}">${lbl(m.status)}</span></td><td><div class="action-buttons"><button class="action-btn" style="background:var(--primary);color:white;" onclick="viewLive('${m.id}')"><i class="fas fa-eye"></i></button>${m.approval_status==="pending"?`<button class="action-btn" style="background:var(--success);color:white;" onclick="approveLive('${m.id}')"><i class="fas fa-check"></i></button><button class="action-btn" style="background:var(--danger);color:white;" onclick="rejectLive('${m.id}')"><i class="fas fa-times"></i></button>`:`<button class="action-btn" style="background:var(--warning);color:white;" onclick="setLivePending('${m.id}')"><i class="fas fa-undo"></i></button>`}<button class="action-btn" style="background:var(--secondary);color:white;" onclick="allowAutoLive('${m.course_id||""}','${m.professor_id||""}')"><i class="fas fa-shield"></i></button><button class="action-btn" style="background:var(--danger);color:white;" onclick="deleteLive('${m.id}')"><i class="fas fa-trash"></i></button></div></td></tr>`).join("")||`<tr><td colspan="8">Nenhuma aula.</td></tr>`}</tbody></table>`;}
function getScrollState(){return{wy:window.scrollY||document.documentElement.scrollTop||document.body.scrollTop||0,my:r.main?r.main.scrollTop:0};}
function restoreScrollState(s){if(!s)return;if(r.main)r.main.scrollTop=s.my||0;document.documentElement.scrollTop=s.wy||0;document.body.scrollTop=s.wy||0;window.scrollTo(0,s.wy||0);}
function render(){if(!r.main)return; if(st.sec==="dashboard"){const p=st.d.materials.filter(x=>x.approval_status==="pending").length;const req=st.d.apps.filter(a=>a.status==="pending").length+st.d.services.filter(s=>s.status==="pending").length;const n=notify();r.main.innerHTML=`<div class="welcome-card"><div><h2>Bem-vindo, ${esc(st.d.admin?.name||"Administrador")}</h2><p>Painel com dados reais da plataforma.</p></div><div class="quick-stats"><div class="stat-item"><h3>${st.d.users.length}</h3><p>Utilizadores</p></div><div class="stat-item"><h3>${st.d.courses.length}</h3><p>Cursos</p></div><div class="stat-item"><h3>${st.d.enrollments.length}</h3><p>Inscrições</p></div></div></div><div class="stats-grid"><div class="stat-card"><div class="stat-icon" style="background:var(--warning);"><i class="fas fa-file-alt"></i></div><div><h3>${p}</h3><p>Materiais pendentes</p></div></div><div class="stat-card"><div class="stat-icon" style="background:var(--secondary);"><i class="fas fa-video"></i></div><div><h3>${st.d.live.length}</h3><p>Aulas ao vivo</p></div></div><div class="stat-card"><div class="stat-icon" style="background:var(--primary);"><i class="fas fa-inbox"></i></div><div><h3>${req}</h3><p>Solicitações pendentes</p></div></div><div class="stat-card"><div class="stat-icon" style="background:var(--success);"><i class="fas fa-users"></i></div><div><h3>${st.d.users.length}</h3><p>Utilizadores ativos</p></div></div></div><div class="table-container"><div class="table-header" style="display:flex;justify-content:space-between;align-items:center;"><h3>Notificacoes recentes</h3><button class="btn btn-secondary" onclick="clearNotifications()">Limpar</button></div><table><thead><tr><th>Tipo</th><th>Notificacao</th><th>Data</th><th>Acao</th></tr></thead><tbody>${n.map(i=>`<tr><td>${esc(i.t)}</td><td>${esc(i.m)}</td><td>${dt(i.d)}</td><td><button class="action-btn" type="button" style="background:var(--secondary);color:white;" onclick="dismissNotification('${esc(i.k)}', this)"><i class="fas fa-times"></i></button></td></tr>`).join("")||`<tr><td colspan="4">Sem notificações.</td></tr>`}</tbody></table></div><div class="charts-grid"><div class="table-container"><div class="table-header"><h3>Distribuição de utilizadores</h3></div><div class="chart-wrap"><canvas id="usersChart" height="130"></canvas></div></div><div class="table-container"><div class="table-header"><h3>Conteúdo publicado</h3></div><div class="chart-wrap"><canvas id="contentChart" height="130"></canvas></div></div></div>`;renderCharts();}
if(st.sec==="materials")r.main.innerHTML=st.d.materials.length?`<div class="table-container"><div class="table-header"><h3>Materiais</h3></div>${mTable(st.d.materials)}</div>`:`<div class="table-container"><div class="table-header"><h3>Materiais</h3></div><div style="padding:24px;text-align:center;color:var(--gray);">Carregando dados...</div></div>`;
if(st.sec==="live")r.main.innerHTML=st.d.live.length?`<div class="table-container"><div class="table-header"><h3>Aulas ao vivo</h3></div>${lTable(st.d.live)}</div>`:`<div class="table-container"><div class="table-header"><h3>Aulas ao vivo</h3></div><div style="padding:24px;text-align:center;color:var(--gray);">Carregando dados...</div></div>`;if(st.sec==="enrollments")r.main.innerHTML=st.d.enrollments.length?`<div class="table-container"><div class="table-header"><h3>Inscrições (${st.d.enrollments.length})</h3></div><table><thead><tr><th>Aluno</th><th>Email</th><th>Curso</th><th>Status</th><th>Pagamento</th><th>Progresso</th><th>Nível</th><th>Data</th><th>Acoes</th></tr></thead><tbody>${st.d.enrollments.map(e=>`<tr data-search="${esc(`${e.student_name} ${e.student_email} ${e.course_title||e.course_id}`)}"><td>${esc(e.student_name)}</td><td>${esc(e.student_email)}</td><td>${esc(e.course_title||e.course_id)}</td><td><span class="status-badge ${cls(e.status)}">${lbl(e.status)}</span></td><td><span class="status-badge ${cls(e.payment_status)}">${esc(e.payment_status)}</span></td><td>${Number(e.progress||10)}%</td><td>${esc(e.level||"iniciante")}</td><td>${dt(e.created_at)}</td><td><div class="action-buttons"><button class="action-btn" style="background:var(--primary);color:white;" onclick="viewEnrollment('${e.id}')"><i class="fas fa-eye"></i></button><button class="action-btn" style="background:var(--secondary);color:white;" onclick="openEnrollmentProgress('${e.id}')"><i class="fas fa-chart-line"></i></button><button class="action-btn" style="background:var(--success);color:white;" onclick="setEnrollmentStatus('${e.id}','approved')"><i class="fas fa-check"></i></button><button class="action-btn" style="background:var(--danger);color:white;" onclick="setEnrollmentStatus('${e.id}','rejected')"><i class="fas fa-times"></i></button><button class="action-btn" style="background:var(--warning);color:white;" onclick="toggleEnrollmentPayment('${e.id}','${e.payment_status==='paid'?'unpaid':'paid'}')"><i class="fas fa-coins"></i></button></div></td></tr>`).join("")||`<tr><td colspan="9">Sem inscricoes.</td></tr>`}</tbody></table></div>`:`<div class="table-container"><div class="table-header"><h3>Inscrições</h3></div><div style="padding:24px;text-align:center;color:var(--gray);">Carregando dados...</div></div>`;
if(st.sec==="users"){if(!st.d.users.length){r.main.innerHTML=`<div class="table-container"><div class="table-header"><h3>Utilizadores</h3></div><div style="padding:24px;text-align:center;color:var(--gray);">Carregando dados...</div></div>`;return;}const grp={Admin:[],professor:[],aluno:[]};const meId=String(st.d.admin?.id||"");const assignmentsByProfessor=new Map();(st.d.courseAssignments||[]).forEach(a=>{const key=String(a.professor_id);if(!assignmentsByProfessor.has(key))assignmentsByProfessor.set(key,[]);assignmentsByProfessor.get(key).push(a.course_title||a.course_id);});st.d.users.forEach(u=>{const r=String(u.role||"aluno");if(grp[r])grp[r].push(u);else grp.aluno.push(u);});const section=(label,list,showCourses)=>`<div class="table-container"><div class="table-header"><h3>${label} (${list.length})</h3><button class="btn btn-secondary" onclick="openUserModal()">Novo utilizador</button></div><table><thead><tr><th>Nome</th><th>Email</th><th>Tipo</th>${showCourses?"<th>Cursos</th>":""}<th>Estado</th><th>Criado em</th><th>Acoes</th></tr></thead><tbody>${list.map(u=>{const isAdmin=String(u.role)==="Admin";const canEditAdmin=isAdmin&&String(u.id)===meId;const courses=showCourses?(assignmentsByProfessor.get(String(u.id))||[]):[];return `<tr data-search="${esc(`${u.name} ${u.email} ${u.role}`)}"><td>${esc(u.name)}</td><td>${esc(u.email)}</td><td>${esc(u.role)}</td>${showCourses?`<td>${courses.length?esc(courses.join(", ")):"-"}</td>`:""}<td><span class="status-badge ${Number(u.active||1)===1?"status-approved":"status-rejected"}">${Number(u.active||1)===1?"Ativo":"Inativo"}</span></td><td>${dt(u.created_at)}</td><td><div class="action-buttons"><button class="action-btn" style="background:var(--primary);color:white;" onclick="viewUser('${u.id}')"><i class="fas fa-eye"></i></button>${isAdmin?(canEditAdmin?`<button class="action-btn" style="background:var(--secondary);color:white;" onclick="editUser('${u.id}')"><i class="fas fa-pen"></i></button>`:""):`<button class="action-btn" style="background:var(--secondary);color:white;" onclick="editUser('${u.id}')"><i class="fas fa-pen"></i></button><button class="action-btn" style="background:var(--warning);color:white;" onclick="toggleUserActive('${u.id}')"><i class="fas fa-power-off"></i></button><button class="action-btn" style="background:var(--danger);color:white;" onclick="deleteUser('${u.id}')"><i class="fas fa-trash"></i></button>`}</div></td></tr>`;}).join("")||`<tr><td colspan="${showCourses?7:6}">Nenhum utilizador.</td></tr>`}</tbody></table></div>`;r.main.innerHTML=section("Administradores",grp.Admin,false)+section("Professores",grp.professor,true)+section("Alunos",grp.aluno,false);}
if(st.sec==="courses"){const mp=cMap();r.main.innerHTML=`<div class="table-container"><div class="table-header"><h3>Cursos (${st.d.courses.length})</h3><button class="btn btn-primary" onclick="openCourse()">Novo curso</button></div><table><thead><tr><th>Título</th><th>Modo</th><th>Duração</th><th>Preço</th><th>Inscritos</th><th>Status</th><th>Acoes</th></tr></thead><tbody>${st.d.courses.map(c=>{const a=Number(c.active)===1;return `<tr data-search="${esc(`${c.title} ${c.mode} ${c.description}`)}"><td>${esc(c.title)}</td><td>${esc(c.mode||"-")}</td><td>${esc(c.duration||"-")}</td><td>${Number(c.price||0).toLocaleString("pt-PT")} MZN</td><td>${mp.get(c.id)||0}</td><td><span class="status-badge ${cls(a?"active":"inactive")}">${a?"Ativo":"Inativo"}</span></td><td><div class="action-buttons"><button class="action-btn" style="background:var(--primary);color:white;" onclick="viewCourse('${c.id}')"><i class="fas fa-eye"></i></button><button class="action-btn" style="background:var(--secondary);color:white;" onclick="openCourse('${c.id}')"><i class="fas fa-pen"></i></button><button class="action-btn" style="background:var(--warning);color:white;" onclick="toggleCourse('${c.id}',${a?0:1})"><i class="fas fa-power-off"></i></button><button class="action-btn" style="background:var(--success);color:white;" onclick="openAssignCourse('${c.id}')"><i class="fas fa-user-plus"></i></button></div></td></tr>`;}).join("")||`<tr><td colspan="7">Nenhum curso.</td></tr>`}</tbody></table></div>`;}
if(st.sec==="requests")r.main.innerHTML=`<div class="table-container"><div class="table-header"><h3>Candidaturas de professores</h3></div><table><thead><tr><th>Nome</th><th>Email</th><th>Area</th><th>Data</th><th>Status</th><th>Acoes</th></tr></thead><tbody>${st.d.apps.map(a=>`<tr data-search="${esc(`${a.name} ${a.email} ${a.profession||""}`)}"><td>${esc(a.name)}</td><td>${esc(a.email)}</td><td>${esc(a.profession||"-")}</td><td>${dt(a.created_at)}</td><td><span class="status-badge ${cls(a.status)}">${lbl(a.status)}</span></td><td><div class="action-buttons"><button class="action-btn" style="background:var(--primary);color:white;" onclick="viewApp('${a.id}')"><i class="fas fa-eye"></i></button>${a.status==="pending"?`<button class="action-btn" style="background:var(--success);color:white;" onclick="approveApp('${a.id}')"><i class="fas fa-check"></i></button><button class="action-btn" style="background:var(--danger);color:white;" onclick="rejectApp('${a.id}')"><i class="fas fa-times"></i></button>`:`<button class="action-btn" style="background:var(--danger);color:white;" onclick="deleteApp('${a.id}')"><i class="fas fa-trash"></i></button>`}</div></td></tr>`).join("")||`<tr><td colspan="6">Sem candidaturas.</td></tr>`}</tbody></table></div><div class="table-container"><div class="table-header"><h3>Pedidos de cursos por professores</h3></div><table><thead><tr><th>Professor</th><th>Curso</th><th>Data</th><th>Status</th><th>Acoes</th></tr></thead><tbody>${(st.d.courseRequests||[]).map(rq=>`<tr><td>${esc(rq.professor_name||"-")}</td><td>${esc(rq.course_title||rq.course_id)}</td><td>${dt(rq.created_at)}</td><td><span class="status-badge ${cls(rq.status)}">${lbl(rq.status)}</span></td><td><div class="action-buttons">${rq.status==="pending"?`<button class="action-btn" style="background:var(--success);color:white;" onclick="approveCourseRequest('${rq.id}')"><i class="fas fa-check"></i></button><button class="action-btn" style="background:var(--danger);color:white;" onclick="rejectCourseRequest('${rq.id}')"><i class="fas fa-times"></i></button>`:`<button class="action-btn" style="background:var(--secondary);color:white;" onclick="viewCourseRequest('${rq.id}')"><i class="fas fa-eye"></i></button>`}</div></td></tr>`).join("")||`<tr><td colspan="5">Sem pedidos.</td></tr>`}</tbody></table></div><div class="table-container"><div class="table-header"><h3>Solicitações de servicos</h3></div><table><thead><tr><th>Cliente</th><th>Servico</th><th>Email</th><th>Data</th><th>Status</th><th>Acoes</th></tr></thead><tbody>${st.d.services.map(s=>`<tr data-search="${esc(`${s.requester_name} ${s.requester_email} ${s.service_name}`)}"><td>${esc(s.requester_name)}</td><td>${esc(s.service_name)}</td><td>${esc(s.requester_email)}</td><td>${dt(s.created_at)}</td><td><span class="status-badge ${cls(s.status)}">${lbl(s.status)}</span></td><td><div class="action-buttons"><button class="action-btn" style="background:var(--primary);color:white;" onclick="viewSrv('${s.id}')"><i class="fas fa-eye"></i></button>${s.status==="pending"?`<button class="action-btn" style="background:var(--success);color:white;" onclick="approveSrv('${s.id}')"><i class="fas fa-check"></i></button><button class="action-btn" style="background:var(--danger);color:white;" onclick="rejectSrv('${s.id}')"><i class="fas fa-times"></i></button>`:`<button class="action-btn" style="background:var(--danger);color:white;" onclick="deleteSrv('${s.id}')"><i class="fas fa-trash"></i></button>`}</div></td></tr>`).join("")||`<tr><td colspan="6">Sem solicitacoes.</td></tr>`}</tbody></table></div>`;
if(st.sec==="chat"){r.main.innerHTML=`<div class="table-container"><div class="table-header"><h3>Grupos de chat (${st.d.chat.length})</h3><button class="btn btn-primary" onclick="openChatGroupModal()">Novo grupo</button></div><table><thead><tr><th>Nome</th><th>Curso</th><th>Criado por</th><th>Data</th><th>Status</th><th>Acoes</th></tr></thead><tbody>${st.d.chat.map(g=>`<tr data-search="${esc(`${g.name} ${g.course_title||""} ${g.created_by_name||""}`)}"><td>${esc(g.name)}</td><td>${esc(g.course_title||"Livre")}</td><td>${esc(g.created_by_name||"-")}</td><td>${dt(g.created_at)}</td><td><span class="status-badge ${cls(g.status)}">${lbl(g.status)}</span></td><td><div class="action-buttons"><button class="action-btn" style="background:var(--primary);color:white;" onclick="viewChat('${g.id}')"><i class="fas fa-eye"></i></button><button class="action-btn" style="background:var(--secondary);color:white;" onclick="openChatGroupModal('${g.id}')"><i class="fas fa-pen"></i></button><button class="action-btn" style="background:var(--danger);color:white;" onclick="deleteChatGroup('${g.id}')"><i class="fas fa-trash"></i></button><button class="action-btn" style="background:var(--secondary);color:white;" onclick="openGroupChat('${g.id}')"><i class="fas fa-comments"></i></button>${g.status==="pending"?`<button class="action-btn" style="background:var(--success);color:white;" onclick="approveChat('${g.id}')"><i class="fas fa-check"></i></button><button class="action-btn" style="background:var(--danger);color:white;" onclick="rejectChat('${g.id}')"><i class="fas fa-times"></i></button>`:`<button class="action-btn" style="background:var(--warning);color:white;" onclick="setChatPending('${g.id}')"><i class="fas fa-undo"></i></button>`}</div></td></tr>`).join("")||`<tr><td colspan="6">Nenhum grupo.</td></tr>`}</tbody></table></div><div class="messages-container" style="margin-top:1.5rem;"><div class="conversations-list">${(st.d.chatRooms||[]).map(g=>`<div class="conversation-item ${String(st.currentChatGroupId)===String(g.id)?"active":""}" onclick="openGroupChat('${g.id}')"><strong>${esc(g.name)}</strong><br><small>${esc(g.course_title||"Grupo livre")}</small></div>`).join("")||`<div class="conversation-item">Sem grupos aprovados para chat.</div>`}</div><div class="chat-area"><div class="chat-header"><h4>${st.currentChatGroupId?"Mensagens do grupo":"Selecione um grupo"}</h4></div><div class="chat-messages" id="chatMessagesArea">${renderChatMessages()}</div><div class="chat-input"><input class="form-control" id="chatInput" placeholder="Escreva uma mensagem" ${st.currentChatGroupId?"":"disabled"}><button class="btn btn-primary" onclick="sendChatMessage()" ${st.currentChatGroupId?"":"disabled"}>Enviar</button></div></div></div>`;const input=id("chatInput");if(input)input.addEventListener("keydown",e=>{if(e.key==="Enter")sendChatMessage();});startChatPolling();}
if(st.sec==="messages")r.main.innerHTML=`<div class="table-container"><div class="table-header"><h3>Mensagens administrativas</h3><button class="btn btn-primary" onclick="openNewMessageModal()">Nova mensagem</button></div><table><thead><tr><th>Para</th><th>Assunto</th><th>Mensagem</th><th>Data</th><th>Admin</th><th>Acoes</th></tr></thead><tbody>${st.d.messages.map(m=>`<tr><td>${esc(m.target_email||"Todos")}</td><td>${esc(m.subject)}</td><td>${esc(m.content)}</td><td>${dt(m.created_at)}</td><td>${esc(m.admin_name||"Admin")}</td><td><button class="action-btn" style="background:var(--danger);color:white;" onclick="deleteAdminMessage('${esc(m.id)}')"><i class="fas fa-trash"></i></button>${m.target_email?`<button class="action-btn" style="background:var(--secondary);color:white;" onclick="replyMessage('${esc(m.target_email)}','${esc(m.subject)}')"><i class="fas fa-reply"></i></button>`:""}</td></tr>`).join("")||`<tr><td colspan="6">Sem mensagens registadas.</td></tr>`}</tbody></table></div>`;
search();}
function renderPreserve(){const s=getScrollState();st.lastScroll=s;render();requestAnimationFrame(()=>restoreScrollState(s));}
function renderChatMessages(){if(!st.currentChatGroupId)return"<div class='message received'>Selecione um grupo para visualizar mensagens.</div>";if(!st.chatMessages.length)return"<div class='message received'>Sem mensagens neste grupo.</div>";const meId=st.d.admin?.id;return st.chatMessages.map(m=>`<div class="message ${String(m.sender_id)===String(meId)?"sent":"received"}"><div><strong>${esc(m.sender_name||"Utilizador")}</strong></div><div>${esc(m.content)}</div><div class="message-time">${dt(m.created_at)}</div></div>`).join("");}
function renderCharts(){if(typeof Chart==="undefined")return;if(st.charts.users){st.charts.users.destroy();st.charts.users=null;}if(st.charts.content){st.charts.content.destroy();st.charts.content=null;}const roles={Admin:0,professor:0,aluno:0};st.d.users.forEach(u=>{if(roles[u.role]!==undefined)roles[u.role]+=1;});const uc=id("usersChart"),cc=id("contentChart");if(uc)st.charts.users=new Chart(uc,{type:"doughnut",data:{labels:["Admin","Professor","Aluno"],datasets:[{data:[roles.Admin,roles.professor,roles.aluno],backgroundColor:["#4361ee","#7209b7","#06d6a0"]}]},options:{responsive:true,maintainAspectRatio:false}});if(cc)st.charts.content=new Chart(cc,{type:"bar",data:{labels:["Cursos","Materiais","Aulas","Mensagens"],datasets:[{label:"Totais",data:[st.d.courses.length,st.d.materials.length,st.d.live.length,st.d.messages.length],backgroundColor:["#4361ee","#ff9e00","#06d6a0","#7209b7"]}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true}}}});}
async function load(){ensure();const safe=async(path,fallback)=>{try{return await api(path);}catch{return fallback;}};const [me,u,c,e,m,l,a,s,ct,g,msg,rooms,cm,cr,ca]=await Promise.all([api("/admin/me"),safe("/admin/users",{users:st.d.users||[]}),safe("/courses",{courses:st.d.courses||[]}),safe("/enrollments",{enrollments:st.d.enrollments||[]}),safe("/admin/materials",{materials:st.d.materials||[]}),safe("/admin/live-classes",{classes:st.d.live||[]}),safe("/admin/teachers/applications",{applications:st.d.apps||[]}),safe("/admin/services/requests",{requests:st.d.services||[]}),safe("/admin/contact-messages",{messages:st.d.contacts||[]}),safe("/admin/chat-groups",{groups:st.d.chat||[]}),safe("/admin/messages",{messages:st.d.messages||[]}),safe("/chat/groups",{groups:st.d.chatRooms||[]}),safe("/admin/chat-messages",{messages:st.d.chatMessages||[]}),safe("/admin/course-requests",{requests:st.d.courseRequests||[]}),safe("/admin/course-assignments",{assignments:st.d.courseAssignments||[]})]);st.d.admin=me.admin||null;st.d.users=u.users||[];st.d.courses=c.courses||[];st.d.enrollments=e.enrollments||[];st.d.materials=m.materials||[];st.d.live=l.classes||[];st.d.apps=a.applications||[];st.d.services=s.requests||[];st.d.contacts=ct.messages||[];st.d.chat=g.groups||[];st.d.messages=msg.messages||[];st.d.chatRooms=rooms.groups||[];st.d.chatMessages=cm.messages||[];st.d.courseRequests=cr.requests||[];st.d.courseAssignments=ca.assignments||[];head();badges();popupRealtime();}
function loadSafe(){if(st.loadingPromise)return st.loadingPromise;st.loadingPromise=load().finally(()=>{st.loadingPromise=null;});return st.loadingPromise;}
async function refresh(msg){const s=getScrollState();st.lastScroll=s;await loadSafe();renderPreserve();restoreScrollState(s);if(msg)toast(msg);} 
function viewMaterial(idv){const m=find(st.d.materials,idv);if(!m)return;details("Detalhes do material",`<p><strong>Título:</strong> ${esc(m.title)}</p><p><strong>Professor:</strong> ${esc(m.professor_name||"-")}</p><p><strong>Email:</strong> ${esc(m.professor_email||"-")}</p><p><strong>Curso:</strong> ${esc(m.course_title||"Geral")}</p><p><strong>Tipo:</strong> ${esc(m.type||"-")}</p><p><strong>Arquivo:</strong> ${esc(m.file_name||"-")}</p><p><strong>Visibilidade:</strong> ${m.visibility==="enrolled"?"Somente inscritos":"Todos"}</p><p><strong>Status:</strong> ${lbl(m.approval_status)}</p><p><strong>Criado em:</strong> ${dt(m.created_at)}</p>`);} function approveMaterial(idv){api(`/admin/materials/${idv}`,{method:"PATCH",body:JSON.stringify({approval_status:"approved"})}).then(()=>refresh("Material aprovado")).catch(e=>toast(e.message,"error"));} function rejectMaterial(idv){decide({title:"Rejeitar material",text:"Confirma a rejeicao deste material?",btn:"Rejeitar",run:async()=>{await api(`/admin/materials/${idv}`,{method:"PATCH",body:JSON.stringify({approval_status:"rejected"})});await refresh("Material rejeitado");}});} function setMaterialPending(idv){api(`/admin/materials/${idv}`,{method:"PATCH",body:JSON.stringify({approval_status:"pending"})}).then(()=>refresh("Material voltou para pendente")).catch(e=>toast(e.message,"error"));}
function viewLive(idv){const x=find(st.d.live,idv);if(!x)return;const contentArr=parseArr(x.content);const matsArr=parseArr(x.support_materials);const contentHtml=contentArr.length?`<ul>${contentArr.map(i=>`<li>${esc(i)}</li>`).join("")}</ul>`:x.content?`<p>${esc(x.content)}</p>`:"<p>-</p>";const matsHtml=matsArr.length?`<ul>${matsArr.map(i=>`<li>${esc(i)}</li>`).join("")}</ul>`:x.support_materials?`<p>${esc(x.support_materials)}</p>`:"<p>-</p>";details("Detalhes da aula",`<p><strong>Título:</strong> ${esc(x.title)}</p><p><strong>Professor:</strong> ${esc(x.professor_name||"-")}</p><p><strong>Curso:</strong> ${esc(x.course_title||"Geral")}</p><p><strong>Inicio:</strong> ${dt(x.scheduled_at||x.created_at)}</p><p><strong>Duração:</strong> ${esc(x.duration_minutes||"-")} minutos</p><p><strong>Vagas:</strong> ${esc(x.capacity||"-")}</p><p><strong>Nível:</strong> ${esc(x.level||"-")}</p><p><strong>Descrição:</strong> ${esc(x.description||"-")}</p><p><strong>Conteúdo:</strong> ${contentHtml}</p><p><strong>Materiais:</strong> ${matsHtml}</p><p><strong>Link:</strong> ${esc(x.meeting_link||"-")}</p><p><strong>Visibilidade:</strong> ${x.visibility==="enrolled"?"Somente inscritos":"Todos"}</p><p><strong>Aprovação:</strong> ${lbl(x.approval_status)}</p><p><strong>Status:</strong> ${lbl(x.status)}</p>`);} function approveLive(idv){api(`/admin/live-classes/${idv}`,{method:"PATCH",body:JSON.stringify({approval_status:"approved"})}).then(()=>refresh("Aula aprovada")).catch(e=>toast(e.message,"error"));} function rejectLive(idv){decide({title:"Rejeitar aula",text:"Confirma a rejeicao desta aula?",btn:"Rejeitar",run:async()=>{await api(`/admin/live-classes/${idv}`,{method:"PATCH",body:JSON.stringify({approval_status:"rejected"})});await refresh("Aula rejeitada");}});} function setLivePending(idv){api(`/admin/live-classes/${idv}`,{method:"PATCH",body:JSON.stringify({approval_status:"pending"})}).then(()=>refresh("Aula voltou para pendente")).catch(e=>toast(e.message,"error"));}
function deleteLive(idv){const x=find(st.d.live,idv);if(!x)return;decide({title:"Apagar aula",text:`Confirma apagar a aula ${x.title}?`,btn:"Apagar",run:async()=>{await api(`/admin/live-classes/${idv}`,{method:"DELETE"});await refresh("Aula apagada");}});}
function allowAutoLive(courseId,professorId){if(!courseId||!professorId){toast("Curso ou professor inválido","error");return;}decide({title:"Permitir aulas sem aprovação",text:"Deseja permitir que este professor agende aulas neste curso sem aprovação?",btn:"Permitir",run:async()=>{await api("/admin/course-permissions",{method:"POST",body:JSON.stringify({course_id:courseId,professor_id:professorId,allow_auto_live:1})});toast("Permissão concedida");}});}
function viewUser(idv){const u=find(st.d.users,idv);if(!u)return;const en=st.d.enrollments.filter(e=>String(e.student_email||"").toLowerCase()===String(u.email||"").toLowerCase());const apps=st.d.apps.filter(a=>String(a.email||"").toLowerCase()===String(u.email||"").toLowerCase());const app=apps[0];const skills=parseArr(app?.skills);const cvs=parseArr(app?.cv_files);details("Ficha completa do utilizador",`<p><strong>Nome:</strong> ${esc(u.name)}</p><p><strong>Email:</strong> ${esc(u.email)}</p><p><strong>Perfil:</strong> ${esc(u.role)}</p><p><strong>Estado:</strong> ${Number(u.active||1)===1?"Ativo":"Inativo"}</p><p><strong>Criado em:</strong> ${dt(u.created_at)}</p><hr><p><strong>Dados de cadastro/candidatura:</strong></p><p><strong>Telefone:</strong> ${esc(app?.phone||"-")}</p><p><strong>Nascimento:</strong> ${esc(app?.birthdate||"-")}</p><p><strong>Username:</strong> ${esc(app?.username||"-")}</p><p><strong>Profissão:</strong> ${esc(app?.profession||"-")}</p><p><strong>Experiência:</strong> ${esc(app?.experience||"-")}</p><p><strong>Formação:</strong> ${esc(app?.education||"-")}</p><p><strong>Habilidades:</strong> ${skills.length?esc(skills.join(", ")):"-"}</p><p><strong>Objetivo:</strong> ${esc(app?.objective||"-")}</p><p><strong>CV/Documentos:</strong></p><ul>${cvs.map(f=>`<li>${esc(f.name||"ficheiro")}${f.size?` (${Math.round(Number(f.size)/1024)} KB)`:""}</li>`).join("")||"<li>Nenhum documento anexado.</li>"}</ul><hr><p><strong>Cursos inscritos:</strong></p><ul>${en.map(e=>`<li>${esc(e.course_title||e.course_id)} - ${esc(e.status)} (${esc(e.payment_status)})</li>`).join("")||"<li>Sem inscricoes encontradas.</li>"}</ul>`);} function openUserModal(){id("modalTitle").textContent="Novo utilizador";id("userId").value="";id("userName").value="";id("userEmail").value="";id("userType").value="aluno";id("userPassword").value="";id("userPassword").placeholder="Defina a password";id("userEmail").disabled=false;id("userType").disabled=false;id("userPassword").disabled=false;openModal("userModal");} function editUser(idv){const u=find(st.d.users,idv);if(!u)return;id("modalTitle").textContent="Editar utilizador";id("userId").value=u.id;id("userName").value=u.name||"";id("userEmail").value=u.email||"";id("userType").value=u.role||"aluno";id("userPassword").value="";id("userPassword").placeholder="Deixe vazio para manter";if(String(u.role)==="Admin"){id("userEmail").disabled=true;id("userType").disabled=true;id("userPassword").disabled=true;}else{ id("userEmail").disabled=false;id("userType").disabled=false;id("userPassword").disabled=false;}openModal("userModal");}
async function saveUser(){const userId=(id("userId").value||"").trim();const name=(id("userName").value||"").trim();const email=(id("userEmail").value||"").trim().toLowerCase();const role=(id("userType").value||"aluno").trim();const password=(id("userPassword").value||"").trim();if(!name||!email){toast("Preencha nome e email","error");return;}if(!userId&&!password){toast("Defina a password para novo utilizador","error");return;}const existing=userId?find(st.d.users,userId):null;const isAdmin=existing&&String(existing.role)==="Admin";const payload={name};if(!isAdmin){payload.email=email;payload.role=role;if(password)payload.password=password;}if(userId){await api(`/admin/users/${userId}`,{method:"PATCH",body:JSON.stringify(payload)});closeModal("userModal");await refresh("Utilizador atualizado");return;}await api("/admin/users",{method:"POST",body:JSON.stringify({name,email,role,password})});closeModal("userModal");await refresh("Utilizador criado");} function deleteUser(idv){const u=find(st.d.users,idv);if(!u)return;decide({title:"Remover utilizador",text:`Confirma remover ${u.name}?`,btn:"Remover",run:async()=>{await api(`/admin/users/${idv}`,{method:"DELETE"});await refresh("Utilizador removido");}});} 
function toggleUserActive(idv){const u=find(st.d.users,idv);if(!u)return;const next=Number(u.active||1)===1?"Inativar":"Ativar";decide({title:`${next} conta`,text:`Confirma ${next.toLowerCase()} a conta de ${u.name}?`,btn:next,run:async()=>{await api(`/admin/users/${idv}/toggle-active`,{method:"POST"});await refresh(`Conta ${next.toLowerCase()}da`);}});}
function openCourse(idv){const c=idv?find(st.d.courses,idv):null;id("courseModalTitle").textContent=c?"Editar curso":"Novo curso";id("courseIdInput").value=c?.id||"";id("courseTitleInput").value=c?.title||"";id("courseDescriptionInput").value=c?.description||"";id("courseModeInput").value=c?.mode||"Online";id("courseDurationInput").value=c?.duration||"";id("coursePriceInput").value=Number(c?.price||0);id("courseActiveInput").value=String(Number(c?.active ? 1 : 0));openModal("courseModal");} async function saveCourse(){const idv=(id("courseIdInput").value||"").trim();const title=(id("courseTitleInput").value||"").trim();const description=(id("courseDescriptionInput").value||"").trim();const mode=(id("courseModeInput").value||"Online").trim();const duration=(id("courseDurationInput").value||"").trim();const price=Number(id("coursePriceInput").value||0);const active=Number(id("courseActiveInput").value||1);if(!title||!description||!mode){toast("Preencha título, descrição e modo","error");return;}const b={title,description,mode,duration,price,active};if(idv){await api(`/courses/${idv}`,{method:"PATCH",body:JSON.stringify(b)});closeModal("courseModal");await refresh("Curso atualizado");return;}await api("/courses",{method:"POST",body:JSON.stringify(b)});closeModal("courseModal");await refresh("Curso criado");} function viewCourse(idv){const c=find(st.d.courses,idv);if(!c)return;const en=st.d.enrollments.filter(e=>String(e.course_id)===String(c.id));const profs=(st.d.courseAssignments||[]).filter(a=>String(a.course_id)===String(c.id)).map(a=>a.professor_name||a.professor_email||a.professor_id);const uniqueProfs=Array.from(new Set(profs.filter(Boolean)));details("Detalhes do curso",`<p><strong>Título:</strong> ${esc(c.title)}</p><p><strong>Descrição:</strong> ${esc(c.description)}</p><p><strong>Modo:</strong> ${esc(c.mode||"-")}</p><p><strong>Duração:</strong> ${esc(c.duration||"-")}</p><p><strong>Preço:</strong> ${Number(c.price||0).toLocaleString("pt-PT")} MZN</p><p><strong>Status:</strong> ${Number(c.active)===1?"Ativo":"Inativo"}</p><p><strong>Professores:</strong></p><ul>${uniqueProfs.map(p=>`<li>${esc(p)}</li>`).join("")||"<li>Sem professores atribuídos.</li>"}</ul><p><strong>Inscritos:</strong></p><ul>${en.map(e=>`<li>${esc(e.student_name)} - ${esc(e.status)} (${esc(e.payment_status)})</li>`).join("")||"<li>Sem inscritos.</li>"}</ul>`);} function toggleCourse(idv,active){api(`/courses/${idv}`,{method:"PATCH",body:JSON.stringify({active})}).then(()=>refresh("Status do curso atualizado")).catch(e=>toast(e.message,"error"));}
function viewApp(idv){const a=find(st.d.apps,idv);if(!a)return;const skills=parseArr(a.skills);const cvs=parseArr(a.cv_files);details("Detalhes da candidatura",`<p><strong>Nome:</strong> ${esc(a.name)}</p><p><strong>Email:</strong> ${esc(a.email)}</p><p><strong>Telefone:</strong> ${esc(a.phone||"-")}</p><p><strong>Nascimento:</strong> ${esc(a.birthdate||"-")}</p><p><strong>Utilizador:</strong> ${esc(a.username||"-")}</p><p><strong>Profissão:</strong> ${esc(a.profession||"-")}</p><p><strong>Experiência:</strong> ${esc(a.experience||"-")}</p><p><strong>Formação:</strong> ${esc(a.education||"-")}</p><p><strong>Habilidades:</strong> ${skills.length?esc(skills.join(", ")):"-"}</p><p><strong>Objetivo:</strong> ${esc(a.objective||"-")}</p><p><strong>CV/Documentos:</strong></p><ul>${cvs.map(f=>`<li>${esc(f.name||"ficheiro")}${f.size?` (${Math.round(Number(f.size)/1024)} KB)`:""}</li>`).join("")||"<li>Nenhum documento anexado.</li>"}</ul><p><strong>Status:</strong> ${lbl(a.status)}</p><p><strong>Notas:</strong> ${esc(a.notes||"-")}</p><p><strong>Data:</strong> ${dt(a.created_at)}</p>`);} function approveApp(idv){api(`/admin/teachers/applications/${idv}`,{method:"PATCH",body:JSON.stringify({status:"approved",notes:"Aprovado pelo admin"})}).then(()=>refresh("Candidatura aprovada")).catch(e=>toast(e.message,"error"));} function rejectApp(idv){decide({title:"Rejeitar candidatura",text:"Informe nota opcional para o candidato.",btn:"Rejeitar",run:async(n)=>{await api(`/admin/teachers/applications/${idv}`,{method:"PATCH",body:JSON.stringify({status:"rejected",notes:n})});await refresh("Candidatura rejeitada");}});} 
function viewSrv(idv){const s=find(st.d.services,idv);if(!s)return;details("Detalhes da solicitacao",`<p><strong>Cliente:</strong> ${esc(s.requester_name)}</p><p><strong>Email:</strong> ${esc(s.requester_email)}</p><p><strong>Telefone:</strong> ${esc(s.requester_phone||"-")}</p><p><strong>Servico:</strong> ${esc(s.service_name)}</p><p><strong>Detalhes:</strong> ${esc(s.details||"-")}</p><p><strong>Status:</strong> ${lbl(s.status)}</p><p><strong>Mensagem ao cliente:</strong> ${esc(s.confirmation_message||"-")}</p>`);} function approveSrv(idv){decide({title:"Aprovar solicitacao",text:"Opcionalmente escreva observacoes para o cliente.",btn:"Aprovar",run:async(n)=>{await api(`/admin/services/requests/${idv}`,{method:"PATCH",body:JSON.stringify({status:"approved",admin_notes:n})});await refresh("Solicitacao aprovada");}});} function rejectSrv(idv){decide({title:"Rejeitar solicitacao",text:"Opcionalmente escreva observacoes para o cliente.",btn:"Rejeitar",run:async(n)=>{await api(`/admin/services/requests/${idv}`,{method:"PATCH",body:JSON.stringify({status:"rejected",admin_notes:n})});await refresh("Solicitacao rejeitada");}});} 
function deleteApp(idv){const a=find(st.d.apps,idv);if(!a)return;decide({title:"Apagar candidatura",text:`Confirma apagar a candidatura de ${a.name}?`,btn:"Apagar",run:async()=>{await api(`/admin/teachers/applications/${idv}`,{method:"DELETE"});await refresh("Candidatura apagada");}});} 
function deleteSrv(idv){const s=find(st.d.services,idv);if(!s)return;decide({title:"Apagar solicitação",text:`Confirma apagar a solicitação de ${s.requester_name}?`,btn:"Apagar",run:async()=>{await api(`/admin/services/requests/${idv}`,{method:"DELETE"});await refresh("Solicitação apagada");}});} 
function openAssignCourse(idv){const c=find(st.d.courses,idv);if(!c)return;const title=id("assignCourseTitle");const select=id("assignCourseProfessor");const students=id("assignCourseStudents");id("assignCourseId").value=c.id;if(title)title.value=c.title||"Curso";const professors=st.d.users.filter(u=>String(u.role)==="professor");select.innerHTML=professors.map(p=>`<option value="${esc(p.id)}">${esc(p.name)} (${esc(p.email)})</option>`).join("")||"<option value=\"\">Nenhum professor disponível</option>";students.value="";openModal("assignCourseModal");}
async function saveAssignCourse(){const courseId=(id("assignCourseId").value||"").trim();const professorId=id("assignCourseProfessor").value;const studentsRaw=(id("assignCourseStudents").value||"").trim();if(!courseId||!professorId){toast("Selecione curso e professor","error");return;}const emails=studentsRaw?studentsRaw.split(/\r?\n|,|;/).map(e=>e.trim()).filter(Boolean):[];await api("/admin/course-assignments",{method:"POST",body:JSON.stringify({course_id:courseId,professor_id:professorId,student_emails:emails})});closeModal("assignCourseModal");await refresh("Curso atribuido ao professor");}
function viewChat(idv){const g=find(st.d.chat,idv);if(!g)return;details("Detalhes do grupo",`<p><strong>Nome:</strong> ${esc(g.name)}</p><p><strong>Curso:</strong> ${esc(g.course_title||"Livre")}</p><p><strong>Criado por:</strong> ${esc(g.created_by_name||"-")}</p><p><strong>Status:</strong> ${lbl(g.status)}</p><p><strong>Notas:</strong> ${esc(g.approval_notes||"-")}</p><p><strong>Criado em:</strong> ${dt(g.created_at)}</p><p><strong>Revisado em:</strong> ${dt(g.reviewed_at)}</p>`);} function approveChat(idv){api(`/admin/chat-groups/${idv}`,{method:"PATCH",body:JSON.stringify({status:"approved"})}).then(()=>refresh("Grupo aprovado")).catch(e=>toast(e.message,"error"));} function rejectChat(idv){decide({title:"Rejeitar grupo",text:"Deseja rejeitar este grupo de chaté",btn:"Rejeitar",run:async(n)=>{await api(`/admin/chat-groups/${idv}`,{method:"PATCH",body:JSON.stringify({status:"rejected",approval_notes:n||null})});await refresh("Grupo rejeitado");}});} function setChatPending(idv){api(`/admin/chat-groups/${idv}`,{method:"PATCH",body:JSON.stringify({status:"pending"})}).then(()=>refresh("Grupo voltou para pendente")).catch(e=>toast(e.message,"error"));}
function viewCourseRequest(idv){const r=find(st.d.courseRequests,idv);if(!r)return;details("Pedido de curso",`<p><strong>Professor:</strong> ${esc(r.professor_name||"-")}</p><p><strong>Curso:</strong> ${esc(r.course_title||r.course_id)}</p><p><strong>Notas:</strong> ${esc(r.notes||"-")}</p><p><strong>Status:</strong> ${lbl(r.status)}</p><p><strong>Data:</strong> ${dt(r.created_at)}</p>`);}
function approveCourseRequest(idv){decide({title:"Aprovar pedido",text:"Deseja aprovar este pedido de curso?",btn:"Aprovar",run:async()=>{await api(`/admin/course-requests/${idv}`,{method:"PATCH",body:JSON.stringify({status:"approved"})});await refresh("Pedido aprovado");}});}
function rejectCourseRequest(idv){decide({title:"Rejeitar pedido",text:"Deseja rejeitar este pedido de curso?",btn:"Rejeitar",run:async(n)=>{await api(`/admin/course-requests/${idv}`,{method:"PATCH",body:JSON.stringify({status:"rejected",notes:n||null})});await refresh("Pedido rejeitado");}});}
function openChatGroupModal(idv){const g=idv?find(st.d.chat,idv):null;id("chatGroupModalTitle").textContent=g?"Editar grupo de chat":"Novo grupo de chat";id("chatGroupIdInput").value=g?.id||"";id("chatGroupNameInput").value=g?.name||"";id("chatGroupStatusInput").value=g?.status||"approved";const s=id("chatGroupCourseInput");if(s){s.innerHTML='<option value="">Grupo livre (sem curso)</option>'+(st.d.courses||[]).map(c=>`<option value="${esc(c.id)}">${esc(c.title)}</option>`).join("");s.value=g?.course_id||"";}openModal("chatGroupModal");}
async function saveChatGroup(){const groupId=(id("chatGroupIdInput").value||"").trim();const name=(id("chatGroupNameInput").value||"").trim();const courseRaw=id("chatGroupCourseInput").value;const status=(id("chatGroupStatusInput").value||"approved").trim();if(!name){toast("Nome do grupo e obrigatorio","error");return;}const payload={name,status,course_id:courseRaw||null};if(groupId){await api(`/admin/chat-groups/${groupId}`,{method:"PATCH",body:JSON.stringify(payload)});closeModal("chatGroupModal");await refresh("Grupo atualizado");return;}await api("/admin/chat-groups",{method:"POST",body:JSON.stringify(payload)});closeModal("chatGroupModal");await refresh("Grupo criado");}
function deleteChatGroup(idv){const g=find(st.d.chat,idv);if(!g)return;decide({title:"Remover grupo",text:`Confirma remover o grupo ${g.name}?`,btn:"Remover",run:async()=>{await api(`/admin/chat-groups/${idv}`,{method:"DELETE"});if(String(st.currentChatGroupId)===String(idv)){st.currentChatGroupId=null;st.chatMessages=[];}await refresh("Grupo removido");}});}
async function openGroupChat(groupId){st.currentChatGroupId=groupId;try{const data=await api(`/chat/groups/${groupId}/messages`);st.chatMessages=data.messages||[];}catch(e){st.chatMessages=[];toast(e.message,"error");}if(st.sec!=="chat")setSection("chat");else render();}
async function sendChatMessage(){const g=st.currentChatGroupId;const input=id("chatInput");const content=(input?.value||"").trim();if(!g||!content)return;await api(`/chat/groups/${g}/messages`,{method:"POST",body:JSON.stringify({content})});if(input)input.value="";await fetchCurrentChatMessages();}
async function fetchCurrentChatMessages(){if(!st.currentChatGroupId)return;const data=await api(`/chat/groups/${st.currentChatGroupId}/messages`);st.chatMessages=data.messages||[];const area=id("chatMessagesArea");if(area){area.innerHTML=renderChatMessages();area.scrollTop=area.scrollHeight;}}
function startChatPolling(){stopChatPolling();st.chatPoll=setInterval(()=>{if(document.hidden)return;if(st.sec==="chat")fetchCurrentChatMessages().catch(()=>{});},12000);} function stopChatPolling(){if(st.chatPoll){clearInterval(st.chatPoll);st.chatPoll=null;}}
function openNewMessageModal(to="",subject=""){const s=id("messageTo");s.innerHTML='<option value="">Todos os utilizadores</option>'+(st.d.users||[]).map(u=>`<option value="${esc(u.email)}">${esc(u.name)} (${esc(u.role)})</option>`).join("");id("messageTo").value=to||"";id("messageSubject").value=subject||"";id("messageContent").value="";openModal("messageModal");}
function deleteAdminMessage(idv){if(!idv)return;decide({title:"Apagar mensagem",text:"Confirma apagar esta mensagem?",btn:"Apagar",run:async()=>{await api(`/admin/messages/${idv}`,{method:"DELETE"});await refresh("Mensagem apagada");}});} function replyMessage(to,subject){openNewMessageModal(to,`Re: ${subject||""}`);} async function sendNewMessage(){const to=(id("messageTo").value||"").trim();const subject=(id("messageSubject").value||"").trim();const content=(id("messageContent").value||"").trim();if(!subject||!content){toast("Preencha assunto e mensagem","error");return;}await api("/admin/messages",{method:"POST",body:JSON.stringify({target_email:to||null,subject,content})});closeModal("messageModal");await refresh("Mensagem enviada");}
function viewEnrollment(idv){const e=find(st.d.enrollments,idv);if(!e)return;details("Detalhes da inscricao","<p><strong>Aluno:</strong> "+esc(e.student_name)+"</p><p><strong>Email:</strong> "+esc(e.student_email)+"</p><p><strong>Curso:</strong> "+esc(e.course_title||e.course_id)+"</p><p><strong>Status:</strong> "+esc(e.status)+"</p><p><strong>Pagamento:</strong> "+esc(e.payment_status)+"</p><p><strong>Progresso:</strong> "+Number(e.progress||10)+"%</p><p><strong>Nível:</strong> "+esc(e.level||"iniciante")+"</p><p><strong>Data:</strong> "+dt(e.created_at)+"</p>");}
function openEnrollmentProgress(idv){const e=find(st.d.enrollments,idv);if(!e)return;id("enrollmentProgressId").value=e.id;id("enrollmentProgressValue").value=Number(e.progress||10);id("enrollmentProgressLevel").value=e.level||"iniciante";openModal("enrollmentProgressModal");}
async function saveEnrollmentProgress(){const idv=id("enrollmentProgressId").value;const progress=Number(id("enrollmentProgressValue").value||0);const level=id("enrollmentProgressLevel").value||"iniciante";if(!idv){toast("Inscricao invalida","error");return;}if(Number.isNaN(progress)||progress<0||progress>100){toast("Progresso deve estar entre 0 e 100","error");return;}try{await api(`/enrollments/${idv}`,{method:"PATCH",body:JSON.stringify({progress,level})});closeModal("enrollmentProgressModal");await refresh("Progresso atualizado");}catch(e){toast(e.message,"error");}}
function setEnrollmentStatus(idv,status){api("/enrollments/"+idv,{method:"PATCH",body:JSON.stringify({status})}).then(()=>refresh("Inscrição atualizada")).catch(e=>toast(e.message,"error"));}
function toggleEnrollmentPayment(idv,payment_status){api("/enrollments/"+idv,{method:"PATCH",body:JSON.stringify({payment_status})}).then(()=>refresh("Pagamento atualizado")).catch(e=>toast(e.message,"error"));}
function startAutoRefresh(){stopAutoRefresh();st.autoRefreshId=setInterval(async()=>{if(document.hidden)return;if(document.querySelector(".modal")&&Array.from(document.querySelectorAll(".modal")).some(m=>m.style.display==="flex"))return;try{await loadSafe();if(["dashboard","requests","messages","chat","enrollments","live"].includes(st.sec))renderPreserve();else badges();}catch{}},15000);}
function stopAutoRefresh(){if(st.autoRefreshId){clearInterval(st.autoRefreshId);st.autoRefreshId=null;}}
function search(){const t=(r.q?.value||"").trim().toLowerCase();(r.main?.querySelectorAll("tbody tr[data-search]")||[]).forEach(tr=>{const s=String(tr.getAttribute("data-search")||"").toLowerCase();tr.style.display=!t||s.includes(t)?"":"none";});}
function rememberSection(sec){try{localStorage.setItem(SECTION_KEY,sec);}catch{}}
function restoreSection(){try{return localStorage.getItem(SECTION_KEY)||"dashboard";}catch{return"dashboard";}}
function ensureData(sec){if(sec==="users"&&st.d.users.length===0)return loadSafe();if(sec==="courses"&&st.d.courses.length===0)return loadSafe();if(sec==="materials"&&st.d.materials.length===0)return loadSafe();if(sec==="live"&&st.d.live.length===0)return loadSafe();if(sec==="enrollments"&&st.d.enrollments.length===0)return loadSafe();return Promise.resolve();}
function setSection(sec){st.sec=sec||"dashboard";rememberSection(st.sec);document.querySelectorAll(".nav-item[data-section]").forEach(n=>n.classList.toggle("active",n.getAttribute("data-section")===st.sec));if(r.q)r.q.value="";if(st.sec!=="chat")stopChatPolling();render();ensureData(st.sec).then(()=>render()).catch(()=>render());}
function logout(){localStorage.removeItem("admin_token");localStorage.removeItem("token");localStorage.removeItem("user");sessionStorage.removeItem("token");sessionStorage.removeItem("user");location.href="login.html";}
function bind(){startAutoRefresh();document.querySelectorAll(".nav-item[data-section]").forEach(n=>n.addEventListener("click",()=>setSection(n.getAttribute("data-section"))));id("courseModalSubmit")?.addEventListener("click",()=>saveCourse().catch(e=>toast(e.message,"error")));id("chatGroupModalSubmit")?.addEventListener("click",()=>saveChatGroup().catch(e=>toast(e.message,"error")));id("enrollmentProgressSubmit")?.addEventListener("click",()=>saveEnrollmentProgress().catch(e=>toast(e.message,"error")));r.q?.addEventListener("input",search);window.addEventListener("click",e=>{if(e.target.classList.contains("modal"))e.target.style.display="none";});if(r.main){r.main.addEventListener("scroll",()=>{st.lastScroll=getScrollState();});}window.addEventListener("scroll",()=>{st.lastScroll=getScrollState();});}
window.openModal=openModal;window.viewEnrollment=viewEnrollment;window.openEnrollmentProgress=openEnrollmentProgress;window.saveEnrollmentProgress=saveEnrollmentProgress;window.setEnrollmentStatus=setEnrollmentStatus;window.toggleEnrollmentPayment=toggleEnrollmentPayment;window.closeModal=closeModal;window.hideToast=hideToast;window.logout=logout;window.setSection=setSection;window.openUserModal=openUserModal;window.editUser=editUser;window.saveUser=()=>saveUser().catch(e=>toast(e.message,"error"));window.deleteUser=deleteUser;window.toggleUserActive=toggleUserActive;window.openNewMessageModal=openNewMessageModal;window.replyMessage=replyMessage;window.sendNewMessage=()=>sendNewMessage().catch(e=>toast(e.message,"error"));window.viewMaterial=viewMaterial;window.approveMaterial=approveMaterial;window.rejectMaterial=rejectMaterial;window.setMaterialPending=setMaterialPending;window.viewLive=viewLive;window.approveLive=approveLive;window.rejectLive=rejectLive;window.setLivePending=setLivePending;window.deleteLive=deleteLive;window.allowAutoLive=allowAutoLive;window.viewUser=viewUser;window.openCourse=openCourse;window.viewCourse=viewCourse;window.toggleCourse=toggleCourse;window.openAssignCourse=openAssignCourse;window.saveAssignCourse=()=>saveAssignCourse().catch(e=>toast(e.message,"error"));window.viewApp=viewApp;window.approveApp=approveApp;window.rejectApp=rejectApp;window.deleteApp=deleteApp;window.viewSrv=viewSrv;window.approveSrv=approveSrv;window.rejectSrv=rejectSrv;window.deleteSrv=deleteSrv;window.viewChat=viewChat;window.approveChat=approveChat;window.rejectChat=rejectChat;window.setChatPending=setChatPending;window.openChatGroupModal=openChatGroupModal;window.saveChatGroup=()=>saveChatGroup().catch(e=>toast(e.message,"error"));window.deleteChatGroup=deleteChatGroup;window.openGroupChat=openGroupChat;window.sendChatMessage=()=>sendChatMessage().catch(e=>toast(e.message,"error"));window.clearNotifications=clearNotifications;window.dismissNotification=dismissNotification;window.deleteAdminMessage=deleteAdminMessage;window.viewCourseRequest=viewCourseRequest;window.approveCourseRequest=approveCourseRequest;window.rejectCourseRequest=rejectCourseRequest;
document.addEventListener("DOMContentLoaded",async()=>{try{loadDismissed();st.sec=restoreSection();await loadSafe();bind();if(r.q)r.q.value="";setSection(st.sec);window.addEventListener("beforeunload",stopAutoRefresh);document.addEventListener("visibilitychange",()=>{if(!document.hidden)refresh().catch(()=>{});});window.addEventListener("focus",()=>refresh().catch(()=>{}));}catch{location.href="login.html";}});
})();











