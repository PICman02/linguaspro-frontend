 const API_BASE = window.__API_URL__ || window.API_URL || "http://localhost:5001/api";  let materiais = [];  const libraryContainer = document.getElementById("libraryContainer"); const materialCount = document.getElementById("materialCount"); const materialsStatTotal = document.getElementById("materialsStatTotal"); const materialsStatVideo = document.getElementById("materialsStatVideo"); const materialsStatQuiz = document.getElementById("materialsStatQuiz"); const searchInput = document.getElementById("searchInput"); const filterType = document.getElementById("filterType"); const filterLanguage = document.getElementById("filterLanguage"); const filterLevel = document.getElementById("filterLevel"); const btnEnviarMaterial = document.getElementById("btnEnviarMaterial");  const enviarMaterialModal = new bootstrap.Modal(document.getElementById("enviarMaterialModal")); const materialDetailModal = new bootstrap.Modal(document.getElementById("materialDetailModal"));  const detailTipo = document.getElementById("detailTipo"); const detailTitulo = document.getElementById("detailTitulo"); const detailDescrição = document.getElementById("detailDescrição"); const detailIdioma = document.getElementById("detailIdioma"); const detailNivel = document.getElementById("detailNivel"); const detailProfessor = document.getElementById("detailProfessor"); const detailDuração = document.getElementById("detailDuração"); const detailVisibility = document.getElementById("detailVisibility"); const downloadButton = document.getElementById("downloadButton"); const quizButton = document.getElementById("quizButton");  function flash(message, type = "success") {  const host = document.querySelector(".library-content .container");  if (!host) return;  const box = document.createElement("div");  box.className = `alert alert-${type}`;  box.textContent = message;  box.style.marginBottom = "1rem";  host.prepend(box);  setTimeout(() => box.remove(), 2800); }  function getToken() {  return localStorage.getItem("token") || sessionStorage.getItem("token") || null; }  function getUser() {  const raw = localStorage.getItem("user") || sessionStorage.getItem("user");  if (!raw) return null;  try {   return JSON.parse(raw);  } catch {   return null;  } }  function tipoIcon(tipo) {  switch (String(tipo || "").toLowerCase()) {   case "video":    return "bi-play-circle-fill";   case "audio":    return "bi-volume-up-fill";   case "slide":   case "slides":    return "bi-file-earmark-slides-fill";   case "exercise":    return "bi-journal-check";   default:    return "bi-file-earmark-text";  } }  function criarCard(material) {  const col = document.createElement("div");  col.className = "col-lg-4 col-md-6 material-card";  col.dataset.type = material.tipo;  col.dataset.language = material.idioma;  col.dataset.level = material.nivel;   col.innerHTML = `   <div class="card h-100 border-0 shadow-sm">    <div class="card-img-top bg-primary bg-opacity-10 p-4 text-center">     <i class="bi ${tipoIcon(material.tipo)} text-primary fs-1"></i>    </div>    <div class="card-body">     <div class="d-flex justify-content-between align-items-start mb-2">      <span class="badge bg-danger text-uppercase">${material.tipo}</span>      <span class="text-muted small">${material.duracao || ""}</span>     </div>     <h5 class="card-title mb-2">${material.título}</h5>     <p class="card-text text-muted small mb-3">${material.descrição}</p>     <div class="mb-3">      <span class="badge bg-light text-dark me-1">${material.idioma}</span>      <span class="badge bg-light text-dark">${material.nivel}</span>     </div>     <div class="d-flex justify-content-between align-items-center">      <small class="text-muted">${material.professor || ""}</small>      <div>       <button class="btn btn-sm btn-outline-primary me-1" onclick="openMaterialModal('${material.id}')">Ver Detalhes</button>       <button class="btn btn-sm btn-success" onclick="downloadMaterial('${material.id}')"><i class="bi bi-download"></i></button>      </div>     </div>    </div>   </div>  `;  return col; }  function updateMaterialCount() {  const visibleCards = Array.from(libraryContainer.children).filter((card) => card.style.display !== "none");  materialCount.textContent = `${visibleCards.length} materiais`; }  function updateHeroCounters() {  if (materialsStatTotal) materialsStatTotal.textContent = String(materiais.length);  if (materialsStatVideo) {   materialsStatVideo.textContent = String(    materiais.filter((item) => String(item.tipo || "").toLowerCase() === "video").length   );  }  if (materialsStatQuiz) {   materialsStatQuiz.textContent = String(    materiais.filter((item) => String(item.tipo || "").toLowerCase() === "quiz").length   );  } }  function renderLibrary() {  libraryContainer.innerHTML = "";  if (materiais.length === 0) {   libraryContainer.innerHTML = `    <div class="col-12">     <div class="alert alert-info text-center">Nenhum material disponível no momento.</div>    </div>   `;   materialCount.textContent = "0 materiais";   updateHeroCounters();   return;  }  materiais.forEach((material) => libraryContainer.appendChild(criarCard(material)));  updateMaterialCount();  updateHeroCounters(); }  function filterMaterials() {  const searchTerm = (searchInput.value || "").toLowerCase();  const selectedType = filterType.value;  const selectedLanguage = filterLanguage.value;  const selectedLevel = filterLevel.value;   Array.from(libraryContainer.children).forEach((card) => {   const title = (card.querySelector(".card-title")?.textContent || "").toLowerCase();   const description = (card.querySelector(".card-text")?.textContent || "").toLowerCase();   const type = card.dataset.type;   const language = card.dataset.language;   const level = card.dataset.level;    let show = true;   if (searchTerm && !title.includes(searchTerm) && !description.includes(searchTerm)) show = false;   if (selectedType !== "all" && type !== selectedType) show = false;   if (selectedLanguage !== "all" && language !== selectedLanguage) show = false;   if (selectedLevel !== "all" && level !== selectedLevel) show = false;   card.style.display = show ? "block" : "none";  });   updateMaterialCount(); }  async function loadLibrary() {  try {   const token = getToken();   const headers = token ? { Authorization: `Bearer ${token}` } : {};   const res = await fetch(`${API_BASE}/library/materials`, { headers });   const data = await res.json().catch(() => ({}));   if (!res.ok) throw new Error(data.error || "Falha ao carregar biblioteca");    materiais = (data.materials || []).map((m) => ({    id: m.id,    tipo: m.type || "pdf",    título: m.title || "Material",    descrição: m.course_title ? `Material do curso ${m.course_title}` : "Material geral",    idioma: (m.course_title || "").toLowerCase().includes("ingles")     ? "ingles"     : (m.course_title || "").toLowerCase().includes("portugues")     ? "portugues"     : (m.course_title || "").toLowerCase().includes("frances")     ? "frances"     : (m.course_title || "").toLowerCase().includes("espanhol")     ? "espanhol"     : "ingles",    nivel: "intermediario",    professor: m.professor_name || "Professor",    duracao: (m.created_at || "").slice(0, 10),    arquivo: m.file_name || "",    course: m.course_title || "Geral",    visibility: m.visibility || "public",   }));   renderLibrary();  } catch (error) {   libraryContainer.innerHTML = `<div class="col-12"><div class="alert alert-danger text-center">${error.message}</div></div>`;   materialCount.textContent = "0 materiais";   materiais = [];   updateHeroCounters();  } }  window.downloadMaterial = function downloadMaterial(id) {  const material = materiais.find((m) => m.id === id);  if (!material) return;  const fileName = material.arquivo || "arquivo";  flash(`Download solicitado para: ${fileName}`, "info"); };  window.openMaterialModal = function openMaterialModal(id) {  const material = materiais.find((m) => m.id === id);  if (!material) return;   detailTipo.textContent = material.tipo;  detailTitulo.textContent = material.título;  detailDescrição.textContent = material.descrição;  detailIdioma.textContent = material.idioma;  detailNivel.textContent = material.nivel;  detailProfessor.textContent = material.professor || "";  detailDuração.textContent = material.duracao || "";  if (detailVisibility) {   detailVisibility.textContent = material.visibility === "enrolled" ? "Somente inscritos" : "Todos";  }   downloadButton.onclick = () => window.downloadMaterial(id);  quizButton.style.display = "none";  materialDetailModal.show(); };  btnEnviarMaterial.addEventListener("click", () => {  const user = getUser();  if (!user || user.role !== "professor") {   flash("Somente professores autenticados podem enviar material.", "warning");   window.location.href = "login.html";   return;  }  enviarMaterialModal.show(); });  document.getElementById("formEnviarMaterial").addEventListener("submit", async (e) => {  e.preventDefault();  const token = getToken();  const user = getUser();  if (!token || !user || user.role !== "professor") {   flash("Sessao invalida para envio de material.", "danger");   return;  }   const título = document.getElementById("materialTitulo").value.trim();  const tipo = document.getElementById("materialTipo").value;  const arquivoInput = document.getElementById("materialArquivo");  const arquivo = arquivoInput.files.length > 0 ? arquivoInput.files[0].name : "";  const visibility = document.getElementById("materialVisibility").value;   if (!título || !tipo) {   flash("Título e tipo são obrigatórios.", "warning");   return;  }   try {   const res = await fetch(`${API_BASE}/professor/materials`, {    method: "POST",    headers: {     "Content-Type": "application/json",     Authorization: `Bearer ${token}`,    },    body: JSON.stringify({     title: título,     type: tipo,     file_name: arquivo,     visibility: visibility || "public",    }),   });   const data = await res.json().catch(() => ({}));   if (!res.ok) throw new Error(data.error || "Falha ao enviar material");    enviarMaterialModal.hide();   document.getElementById("formEnviarMaterial").reset();   await loadLibrary();   flash("Material enviado com sucesso.");  } catch (error) {   flash(error.message || "Erro ao enviar material", "danger");  } });  document.addEventListener("DOMContentLoaded", () => {  loadLibrary();  searchInput.addEventListener("input", filterMaterials);  filterType.addEventListener("change", filterMaterials);  filterLanguage.addEventListener("change", filterMaterials);  filterLevel.addEventListener("change", filterMaterials); });   